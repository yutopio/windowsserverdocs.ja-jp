---
title: Hyper-v ハイパーバイザーのスケジューラの種類について理解し、使用する
description: Hyper-v のスケジューラモードの使用に関する Hyper-v ホスト管理者向けの情報を提供します。
ms.author: benarm
author: BenjaminArmstrong
ms.date: 08/14/2018
ms.topic: article
ms.localizationpriority: low
ms.assetid: 6cb13f84-cb50-4e60-a685-54f67c9146be
ms.openlocfilehash: 8dc2fec785771db4ccefb08e2359506932e11620
ms.sourcegitcommit: 8c0a419ae5483159548eb0bc159f4b774d4c3d85
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/03/2020
ms.locfileid: "93235869"
---
# <a name="managing-hyper-v-hypervisor-scheduler-types"></a>Hyper-v ハイパーバイザーのスケジューラの種類の管理

>適用対象: Windows 10、Windows Server 2016、Windows Server、バージョン1709、Windows Server、バージョン1803、Windows Server 2019

この記事では、Windows Server 2016 で初めて導入された仮想プロセッサスケジューリングロジックの新しいモードについて説明します。 これらのモードまたはスケジューラの種類によって、Hyper-v ハイパーバイザーがゲスト仮想プロセッサ間での作業の割り当てと管理を行う方法が決まります。 Hyper-v ホスト管理者は、ゲスト仮想マシン (Vm) に最適なハイパーバイザースケジューラの種類を選択し、スケジュールロジックを利用するように Vm を構成できます。

> [!NOTE]
> このドキュメントで説明されているハイパーバイザースケジューラ機能を使用するには、更新プログラムが必要です。 詳細については、「 [必須の更新プログラム](#required-updates)」を参照してください。

## <a name="background"></a>バックグラウンド

Hyper-v 仮想プロセッサスケジュールの背後にあるロジックと制御について説明する前に、この記事で説明されている基本的な概念を確認することをお勧めします。

### <a name="understanding-smt"></a>SMT について

同時マルチスレッド (SMT) は、プロセッサのリソースを個別の独立した実行スレッドで共有できるようにする、最新のプロセッサ設計で使用される手法です。 SMT は、一般に、可能な場合に計算を並列化することで、ほとんどのワークロードに対して適度なパフォーマンスを実現します。また、命令のスループットは向上しますが、共有プロセッサリソースのスレッド間の競合が発生した場合にパフォーマンスがわずかに低下する可能性があります。
SMT をサポートするプロセッサは、Intel と AMD の両方から使用できます。 Intel は、Intel ハイパースレッディングテクノロジ (intel HT) として、SMT 製品を指します。

この記事では、SMT の説明と Hyper-v での使用方法について、Intel と AMD の両方のシステムに均等に適用します。

* Intel HT テクノロジの詳細については、「 [intel Hyper-Threading テクノロジ](https://www.intel.com/content/www/us/en/architecture-and-technology/hyper-threading/hyper-threading-technology.html)」を参照してください。

* AMD SMT の詳細については、 [「Zen (コアアーキテクチャ](https://www.amd.com/en/technologies/zen-core))」を参照してください。

## <a name="understanding-how-hyper-v-virtualizes-processors"></a>Hyper-v がプロセッサを仮想化するしくみについて

ハイパーバイザースケジューラの種類を検討する前に、Hyper-v アーキテクチャについて理解しておくことも役立ちます。 一般的な概要については、 [「Hyper-v テクノロジの概要](../hyper-v-technology-overview.md)」を参照してください。 この記事の重要な概念は次のとおりです。

* Hyper-v は、ハイパーバイザーの制御下で、コンピューティングリソースが割り当てられ共有される仮想マシンパーティションを作成して管理します。 パーティションは、すべてのゲスト仮想マシン間、およびゲスト Vm とルートパーティションの間に強力な分離境界を提供します。

* ルートパーティション自体は仮想マシンパーティションですが、一意のプロパティと、ゲスト仮想マシンよりもはるかに高い特権があります。 ルートパーティションは、すべてのゲスト仮想マシンを制御し、ゲストの仮想デバイスのサポートを提供し、ゲスト仮想マシンのすべてのデバイス i/o を管理する管理サービスを提供します。 ルートパーティションでは、アプリケーションのワークロードを実行しないことを強くお勧めします。

* ルートパーティションの各仮想プロセッサ (VP) は、1:1 を基になる論理プロセッサ (LP) にマップされます。 ホスト VP は、常に同じ基になる LP で実行されます。ルートパーティションの VPs は移行されません。

* 既定では、ホスト VPs を実行する LPs でも、ゲスト VPs を実行できます。

* ゲスト副社長は、使用可能な任意の論理プロセッサ上で実行するようにハイパーバイザーによってスケジュールされる場合があります。 ハイパーバイザースケジューラは、テンポラルキャッシュの局所性、NUMA トポロジ、およびゲスト VP をスケジュールする際のその他の多くの要因を考慮する必要がありますが、最終的には、どのホスト LP でも VP をスケジュールすることができます。

## <a name="hypervisor-scheduler-types"></a>ハイパーバイザースケジューラの種類

Windows Server 2016 以降では、Hyper-v ハイパーバイザーは、ハイパーバイザーが基になる論理プロセッサの仮想プロセッサをスケジュールする方法を決定する、スケジューラロジックのいくつかのモードをサポートしています。 これらのスケジューラの種類は次のとおりです。

### <a name="the-classic-scheduler"></a>クラシックスケジューラ

クラシックスケジューラは、windows Server 2016 Hyper-v を含む、Windows Hyper-v ハイパーバイザーの開始以降のすべてのバージョンに対して既定の設定になっています。 クラシックスケジューラは、ゲスト仮想プロセッサに対してフェアシェアのプリエンプティブなラウンドロビンスケジューリングモデルを提供します。

従来のスケジューラの種類は、プライベートクラウドやホスティングプロバイダーなどに使用される従来の Hyper-v の大部分に最も適しています。 パフォーマンス特性はよく理解されており、VPs から LPs へのクロスサブスクリプション、多数の異種 Vm とワークロードを同時に実行する、大規模な高パフォーマンス Vm を実行する、制限のない Hyper-v の完全な機能セットをサポートするなど、さまざまな仮想化シナリオをサポートするために最適に最適化されています。

### <a name="the-core-scheduler"></a>コアスケジューラ

ハイパーバイザーコアスケジューラは、Windows Server 2016 および Windows 10 バージョン1607で導入された従来のスケジューラロジックに代わる新しい手段です。 コアスケジューラは、ゲストワークロードの分離に強力なセキュリティ境界を提供し、SMT が有効な仮想化ホスト上で実行されている Vm 内のワークロードのパフォーマンスの変動を軽減します。 コアスケジューラを使用すると、smt と SMT 以外の仮想マシンの両方を同じ SMT 対応仮想化ホスト上で同時に実行できます。

コアスケジューラは、仮想化ホストの SMT トポロジを利用し、必要に応じて、ゲスト仮想マシンに対して SMT ペアを公開し、同じバーチャルマシンのゲスト仮想プロセッサのグループを SMT 論理プロセッサのグループにスケジュールします。 これは、LPs が2のグループに含まれている場合、VPs が2つのグループにスケジュールされ、コアが Vm 間で共有されないようにするために、対称的に実行されます。
SMT が有効になっていない仮想マシンに対して VP がスケジュールされている場合、その VP は実行時にコア全体を消費します。

コアスケジューラの全体的な結果は次のようになります。

* ゲスト VPs は、基盤となる物理コアペアで実行するように制約されているため、VM をプロセッサコアの境界に分離することにより、悪意のある Vm からのサイドチャネルのスヌーピング攻撃に対する脆弱性を軽減できます。

* スループットの変動が大幅に減少します。

* パフォーマンスが低下する可能性があります。これは、VPs のグループのいずれか1つしか実行できない場合、コア内の1つの命令ストリームだけがアイドル状態のままになるためです。

* ゲスト仮想マシンで実行されている OS とアプリケーションは、SMT の動作とプログラミングインターフェイス (Api) を使用して、非仮想化を実行する場合と同様に、SMT スレッド間で作業を制御および分散できます。

* ゲストワークロードの分離のための強力なセキュリティ境界-ゲスト VPs は、基盤となる物理コアペアで実行するように制約されているため、サイドチャネルの覗き見攻撃に対する脆弱性が軽減されます。

コアスケジューラは、既定では Windows Server 2019 以降で使用されます。 Windows Server 2016 では、コアスケジューラはオプションであり、Hyper-v ホスト管理者が明示的に有効にする必要があります。また、クラシックスケジューラが既定値です。

#### <a name="core-scheduler-behavior-with-host-smt-disabled"></a>ホストの SMT が無効になっているコアスケジューラの動作

ハイパーバイザーがコアスケジューラの種類を使用するように構成されているにもかかわらず、SMT 機能が無効になっているか、仮想化ホスト上に存在しない場合、ハイパーバイザーは、ハイパーバイザースケジューラの種類の設定に関係なく、従来のスケジューラの動作を使用します。

### <a name="the-root-scheduler"></a>ルートスケジューラ

ルートスケジューラは、Windows 10 バージョン1803で導入されました。 ルートスケジューラの種類が有効になっている場合、ハイパーバイザー渡しは、ルートパーティションに対する作業スケジュールを制御します。 ルートパーティションの OS インスタンスの NT スケジューラは、システム LPs に対する作業のスケジューリングのすべての側面を管理します。

ルートスケジューラは、Windows Defender Application Guard (WDAG) で使用される強力なワークロードの分離を実現するために、ユーティリティパーティションのサポートに固有の固有の要件に対応します。 このシナリオでは、ルート OS に対してスケジュール責任を残しておくと、いくつかの利点があります。 たとえば、コンテナーシナリオに適用される CPU リソース制御をユーティリティパーティションと共に使用して、管理と展開を簡略化することができます。 さらに、ルート OS スケジューラは、コンテナー内のワークロードの CPU 使用率に関するメトリックを簡単に収集し、このデータをシステム内の他のすべてのワークロードに適用される同じスケジューリングポリシーへの入力として使用します。 これらの同じメトリックは、ホストシステムに対してアプリケーションコンテナーで実行される処理を明確にするのにも役立ちます。 従来の仮想マシンのワークロードでは、これらのメトリックの追跡がより困難になります。これは、実行中のすべての VM に対して何らかの作業がルートパーティションで行われる場合です。

#### <a name="root-scheduler-use-on-client-systems"></a>クライアントシステムでのルートスケジューラの使用

Windows 10 バージョン1803以降では、ルートスケジューラは、既定ではクライアントシステムでのみ使用されます。この場合、仮想化ベースのセキュリティと WDAG ワークロードの分離のサポートでハイパーバイザーが有効になり、異種コアアーキテクチャを使用する将来のシステムを適切に操作できるようになります。 これは、クライアントシステムでサポートされている唯一のハイパーバイザースケジューラ構成です。 管理者は、Windows 10 クライアントシステムで既定のハイパーバイザースケジューラの種類を上書きしないようにする必要があります。

#### <a name="virtual-machine-cpu-resource-controls-and-the-root-scheduler"></a>仮想マシンの CPU リソース制御とルートスケジューラ

Hyper-v によって提供される仮想マシンのプロセッサリソースコントロールは、ハイパーバイザールートスケジューラが有効になっている場合はサポートされません。これは、ルートオペレーティングシステムのスケジューラロジックがグローバルベースでホストリソースを管理し、VM 固有の構成設定についての知識がないためです。 Cap、重み、予約など、Hyper-v の VM ごとのプロセッサリソース制御は、ハイパーバイザーが、たとえば、クラシックおよびコアスケジューラの種類のように VP スケジュールを直接制御する場合にのみ適用できます。

#### <a name="root-scheduler-use-on-server-systems"></a>サーバーシステムでのルートスケジューラの使用

現時点では、サーバー上の Hyper-v ではルートスケジューラを使用しないことをお勧めします。これは、多くのサーバー仮想化展開で一般的なさまざまなワークロードに対応するために、パフォーマンス特性がまだ完全に特徴付けられていないためです。

## <a name="enabling-smt-in-guest-virtual-machines"></a>ゲスト仮想マシンでの SMT の有効化

コアスケジューラの種類を使用するように仮想化ホストのハイパーバイザーが構成されたら、必要に応じて、SMT を利用するようにゲスト仮想マシンを構成できます。 VPs がハイパースレッドとしてゲスト仮想マシンに対応しているという事実を公開すると、ゲストオペレーティングシステムのスケジューラと VM で実行されているワークロードが、独自の作業スケジュールで SMT トポロジを検出して使用できるようになります。 Windows Server 2016 では、ゲスト SMT は既定では構成されていないため、Hyper-v ホスト管理者が明示的に有効にする必要があります。 Windows Server 2019 以降では、ホスト上に作成された新しい Vm は、既定でホストの SMT トポロジを継承します。  つまり、コアあたり2つの SMT スレッドを使用してホスト上に作成されたバージョン9.0 の VM も、コアあたり2つの SMT スレッドになります。

ゲスト仮想マシンで SMT を有効にするには、PowerShell を使用する必要があります。Hyper-v マネージャーでは、ユーザーインターフェイスは提供されていません。
ゲスト仮想マシンで SMT を有効にするには、十分なアクセス許可を持つ PowerShell ウィンドウを開き、次のように入力します。

``` powershell
Set-VMProcessor -VMName <VMName> -HwThreadCountPerCore <n>
```

ここ <n> で、は、ゲスト VM が認識する、コアあたりの SMT スレッド数です。
<n>= 0 は、コア値あたりのホストの SMT スレッド数に一致するように HwThreadCountPerCore 値を設定することに注意してください。

> [!NOTE]
> HwThreadCountPerCore = 0 の設定は、Windows Server 2019 以降でサポートされています。

2つの仮想プロセッサと SMT が有効になっている仮想マシンで実行されているゲストオペレーティングシステムから取得したシステム情報の例を次に示します。 ゲストオペレーティングシステムが、同じコアに属する2つの論理プロセッサを検出しています。

![SMT が有効になっているゲスト VM の msinfo32 を示すスクリーンショット](media/Hyper-V-CoreScheduler-VM-Msinfo32.png)

## <a name="configuring-the-hypervisor-scheduler-type-on-windows-server-2016-hyper-v"></a>Windows Server 2016 Hyper-v でのハイパーバイザースケジューラの種類の構成

Windows Server 2016 Hyper-v では、従来のハイパーバイザースケジューラモデルが既定で使用されます。 ハイパーバイザーは、必要に応じて、コアスケジューラを使用するように構成できます。これにより、ゲスト VPs が対応する物理的な SMT ペアで実行されるように制限し、ゲスト VPs に対して SMT スケジューリング付きの仮想マシンの使用をサポートすることで、セキュリティを強化することができます。

> [!NOTE]
> Windows Server 2016 Hyper-v を実行するすべてのお客様は、仮想化ホストが悪意のある可能性のあるゲスト Vm から確実に保護されるように、コアスケジューラを選択することをお勧めします。

## <a name="windows-server-2019-hyper-v-defaults-to-using-the-core-scheduler"></a>Windows Server 2019 Hyper-v は、既定でコアスケジューラを使用する

最適なセキュリティ構成で Hyper-v ホストを確実に展開できるように、Windows Server 2019 Hyper-v では、既定でコアハイパーバイザースケジューラモデルが使用されるようになりました。 ホスト管理者は、必要に応じて、従来のクラシックスケジューラを使用するようにホストを構成することができます。 管理者は、スケジューラの種類の既定の設定を上書きする前に、各スケジューラの種類が仮想化ホストのセキュリティとパフォーマンスに与える影響を慎重に確認し、理解し、考慮する必要があります。 詳細については [、「hyper-v ハイパーバイザースケジューラの種類の選択につい](https://docs.microsoft.com/windows-server/virtualization/hyper-v/manage/about-hyper-v-scheduler-type-selection) て」を参照してください。

### <a name="required-updates"></a>必要な更新プログラム

> [!NOTE]
> このドキュメントで説明されているハイパーバイザースケジューラ機能を使用するには、次の更新プログラムが必要です。 これらの更新プログラムには、 `hypervisorschedulertype` ホストの構成に必要な新しい BCD オプションをサポートするための変更が含まれています。

| Version | リリース  | 更新が必要 | KB Article |
|--------------------|------|---------|-------------:|
|Windows Server 2016 | 1607 | 2018.07 C | [KB4338822](https://support.microsoft.com/help/4338822/windows-10-update-kb4338822) |
|Windows Server 2016 | 1703 | 2018.07 C | [KB4338827](https://support.microsoft.com/help/4338827/windows-10-update-kb4338827) |
|Windows Server 2016 | 1709 | 2018.07 C | [KB4338817](https://support.microsoft.com/help/4338817/windows-10-update-kb4338817) |
|Windows Server 2019 | 1804 | なし | なし |

## <a name="selecting-the-hypervisor-scheduler-type-on-windows-server"></a>Windows Server でのハイパーバイザースケジューラの種類の選択

ハイパーバイザースケジューラの構成は、hypervisorscheduler type BCD エントリを介して制御されます。

スケジューラの種類を選択するには、管理者特権でコマンドプロンプトを開きます。

```
bcdedit /set hypervisorschedulertype type
```

`type`は次のいずれかです。

* Classic (クラシック)
* コア
* Root

ハイパーバイザースケジューラの種類に対する変更を有効にするには、システムを再起動する必要があります。

> [!NOTE]
> 現時点では、Windows Server Hyper-v ではハイパーバイザールートスケジューラはサポートされていません。 Hyper-v 管理者は、サーバー仮想化シナリオで使用するためのルートスケジューラの構成を試行しないでください。

## <a name="determining-the-current-scheduler-type"></a>現在のスケジューラの種類の決定

現在使用されているハイパーバイザースケジューラの種類を確認するには、最新のハイパーバイザー起動イベント ID 2 のシステムログイベントビューアーを調べます。これは、ハイパーバイザーの起動時に構成されたハイパーバイザースケジューラの種類を報告します。 ハイパーバイザー起動イベントは、Windows イベントビューアーから、または PowerShell を使用して取得できます。

ハイパーバイザー起動イベント ID 2 は、次のようなハイパーバイザースケジューラの種類を表します。

- 1 = クラシックスケジューラ、SMT disabled

- 2 = クラシックスケジューラ

- 3 = コアスケジューラ

- 4 = ルートスケジューラ

![ハイパーバイザー起動イベント ID 2 の詳細を示すスクリーンショット](media/Hyper-V-CoreScheduler-EventID2-Details.png)

![ハイパーバイザー起動イベント ID 2 を表示するイベントビューアーを示すスクリーンショット](media/Hyper-V-CoreScheduler-EventViewer.png)

### <a name="querying-the-hyper-v-hypervisor-scheduler-type-launch-event-using-powershell"></a>PowerShell を使用して Hyper-v ハイパーバイザースケジューラの種類の起動イベントを照会する

PowerShell を使用してハイパーバイザーイベント ID 2 を照会するには、PowerShell プロンプトから次のコマンドを入力します。

``` powershell
Get-WinEvent -FilterHashTable @{ProviderName="Microsoft-Windows-Hyper-V-Hypervisor"; ID=2} -MaxEvents 1
```

![ハイパーバイザー起動イベント ID 2 の PowerShell クエリと結果を示すスクリーンショット](media/Hyper-V-CoreScheduler-PowerShell.png)
