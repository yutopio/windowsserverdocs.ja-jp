---
title: Storage Migration Service でのカットオーバーのしくみ
description: Storage Migration Service のカットダウンステージの概要と詳細
author: nedpyle
ms.author: nedpyle
ms.date: 08/31/2020
ms.topic: article
ms.openlocfilehash: 2f323b03052f0a920ff064860bf5cbf4c6a2f01e
ms.sourcegitcommit: 014e730c7fb19ed06393d144a446e4248fc35444
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/29/2020
ms.locfileid: "91495649"
---
# <a name="how-cutover-works-in-storage-migration-service"></a>Storage Migration Service でのカットオーバーのしくみ

"カットオーバー" とは、移行元コンピューターのネットワーク id を移行先コンピューターに移動する移行のフェーズです。 カットオーバー後も、ソースコンピューターには以前と同じファイルが含まれていますが、ユーザーとアプリでは使用できません。

## <a name="summary"></a>まとめ

![構成の切り替えのスクリーンショット ](media/cutover/cutover_configuration.png)
 __図 1: 記憶域移行サービスの構成__の切り替え

カットオーバーを開始する前に、移行元コンピューターから移行先コンピューターにカットオーバーするために必要なネットワーク構成情報を指定します。 また、ソースコンピューターの新しい一意の名前を選択したり、記憶域移行サービスでランダムな名前を作成したりすることもできます。

次に、記憶域移行サービスは、移行元コンピューターを移行先コンピューターに移行するために、次の手順を実行します。

1. 移行元と移行先のコンピューターに接続します。 どちらの場合も、次のファイアウォールルールが有効になっている必要があります。
    * ファイルとプリンターの共有 (SMB 受信)、TCP ポート445
    * Netlogon サービス (NP 受信)、TCP ポート445
    * Windows Management Instrumentation (DCOM)、TCP ポート135
    * Windows Management Instrumentation (WMI)、TCP、任意のポート

2. ソースコンピューターのアクセス許可と一致するように、Active Directory Domain Services の対象コンピューターにセキュリティのアクセス許可を設定します。

3. ソースコンピューターに一時的なローカルユーザーアカウントを作成します。 コンピューターがドメインに参加している場合、アカウントのユーザー名は "MsftSmsStorMigratSvc" になります。 ソースコンピューターの [ローカルアカウントトークンフィルターポリシー](https://support.microsoft.com/help/951016/description-of-user-account-control-and-remote-restrictions-in-windows) を無効にして、を介してアカウントを許可し、ソースコンピューターに接続します。 この一時的なアカウントを作成すると、後でドメインからソースコンピューターを再起動して削除しても、ソースコンピューターには引き続きアクセスできます。

4. 先のコンピューターで前の手順を繰り返します。

5. ドメインからソースコンピューターを削除して Active Directory アカウントを解放します。このアカウントは、後で対象コンピューターが引き継ぎます。

6. ソースコンピューターのネットワークインターフェイスをマップし、ソースコンピューターの名前を変更します。

7. ソースコンピューターをドメインに再び追加します。 ソースコンピューターは新しい id を持ち、管理者が利用できますが、ユーザーとアプリには使用できません。

8. 移行元コンピューターで、他のすべての代替コンピューター名を削除し、作成した一時的なローカルアカウントを削除して、ローカルアカウントトークンフィルターポリシーを再び有効にします。

9. 対象のコンピューターをドメインから削除します。

10. 移行先コンピューターの IP アドレスをソースによって提供される IP 情報に置き換えてから、移行先コンピューターの名前をソースコンピューターの元の名前に変更します。

11. セットアップ先のコンピューターをドメインに戻します。 参加すると、ソースコンピューターの元の Active Directory コンピューターアカウントが使用されます。 これにより、グループのメンバーシップとセキュリティ Acl が保持されます。 これで、セットアップ先のコンピューターにソースコンピューターの id が追加されました。

12. 対象のコンピューターでは、他のすべての代替コンピューター名を削除し、作成した一時的なローカルアカウントを削除して、ローカルアカウントのトークンフィルターポリシーを再度有効にして、カットオーバーを完了します。

移行が完了すると、移行先コンピューターはソースコンピューターの id を取得し、ソースコンピューターを使用停止にすることができます。

## <a name="detailed-stages"></a>詳細なステージ

![カットオーバーステージの説明スクリーンショット ](media/cutover/cutover_stage_description.png)
 __図 2: カットオーバーステージの説明を示すストレージ移行サービス__

上の図に示されているように、各ステージの説明に従って、カットオーバーの進行状況を追跡できます。 次の表に、考えられる各ステージとその進行状況、説明、および明確な注意事項を示します。

|  進捗状況 | 説明                                                                                               |  メモ |
|:-----|:--------------------------------------------------------------------------------------------------------------------|:---|
|  0% | カットオーバーはアイドル状態です。 |   |
| 2%  | ソースコンピューターに接続しています... |   [移行元と移行先の両方のコンピューターの要件](./overview.md#security-requirements-the-storage-migration-service-proxy-service-and-firewall-ports)が満たされていることを確認してください。|
| 5%  | 対象のコンピューターに接続しています... |   |
| 6%  | Active Directory のコンピューターオブジェクトに対するセキュリティのアクセス許可を設定しています... |   移行先コンピューターのソースコンピューターの Active Directory オブジェクトのセキュリティアクセス許可をレプリケートします。|
| 8%  | 作成した一時アカウントがソースコンピューターで正常に削除されたことを確認しています... |   同じ名前の一時的なアカウントを作成できることを確認します。|
| 11% | ソースコンピューターで一時ローカルユーザーアカウントを作成しています... |   ソースコンピュータがドメインに参加している場合、一時アカウントのユーザー名は "MsftSmsStorMigratSvc" になります。 パスワードは、文字、数字、記号、および大文字小文字の変更を含む127のランダム unicode ワイド文字で構成されます。 ソースコンピューターがワークグループ内にある場合は、元のソース資格情報を使用します。|
| 13% | ソースコンピューターでローカルアカウントトークンのフィルターポリシーを設定しています... |   ドメインに参加していない場合にソースに接続できるように、ポリシーを無効にします。 ローカルアカウントトークンフィルターポリシーの詳細について [は、こちら](https://support.microsoft.com/help/951016/description-of-user-account-control-and-remote-restrictions-in-windows)を参照してください。|
| 16% | 一時ローカルユーザーアカウントを使用してソースコンピューターに接続しています... |   |
| 19% | 作成した一時アカウントが対象のコンピューターで正常に削除されたことを確認しています... |   |
| 22% | 対象のコンピューターに一時ローカルユーザーアカウントを作成しています... | 対象のコンピューターがドメインに参加している場合、一時アカウントのユーザー名は "MsftSmsStorMigratSvc" になります。 パスワードは、文字、数字、記号、および大文字小文字の変更を含む127のランダム unicode ワイド文字で構成されます。 対象のコンピューターがワークグループにある場合は、元の送信先の資格情報を使用します。 |
| 25% | 対象コンピューターでローカルアカウントトークンのフィルターポリシーを設定しています... | ドメインに参加していないときに宛先に接続できるように、ポリシーを無効にします。 ローカルアカウントトークンフィルターポリシーの詳細について [は、こちら](https://support.microsoft.com/help/951016/description-of-user-account-control-and-remote-restrictions-in-windows)を参照してください。   |
| 27% | 一時ローカルユーザーアカウントを使用して対象コンピューターに接続しています... |   |
| 30% | ドメインからソースコンピューターを削除しています... |   |
| 半角 | ソースコンピューターの IP アドレスを収集しています。 |   Linux ソースコンピューターにのみ適用されます。 |
| 33% | ソースコンピューターを再起動しています...(1 回目の再起動) |   |
| 36% | 最初の再起動後にソースコンピューターが応答するのを待機しています... |   ソースコンピュータが DHCP サブネットに含まれていないが、ネットワークの構成中に DHCP を選択した場合、応答しなくなる可能性があります。|
| 38% | ソースコンピューターのネットワークインターフェイスをマップしています... |   |
| 41% | ソースコンピューターの名前を変更しています... |   |
| 42% | ソースコンピューターを再起動しています...(1 回目の再起動) |   Linux ソースコンピューターにのみ適用されます。|
| 43% | ソースコンピューターを再起動しています...(2 回目の再起動) |   ドメインに参加している Windows Server 2003 ソースコンピューターにのみ適用されます。|
| 43% | 最初の再起動後にソースコンピューターが応答するのを待機しています... |   |
| 43% | 2回目の再起動後にソースコンピューターが応答するのを待機しています... |   |
| 44% | ソースコンピューターをドメインに追加しています... |   |
| 47% | ソースコンピューターを再起動しています...(1 回目の再起動) |   |
| 50% | ソースコンピューターを再起動しています...(2 回目の再起動) |   |
| 51% | ソースコンピューターを再起動しています...(3 番目の再起動) |   Windows Server 2003 のソースコンピューターにのみ適用されます。|
| 52% | ソースコンピューターが応答するのを待機しています... |   |
| 52% | 最初の再起動後にソースコンピューターが応答するのを待機しています... |   |
| 55% | 2回目の再起動後にソースコンピューターが応答するのを待機しています... |   |
| 56% | 3番目の再起動後にソースコンピューターが応答するのを待機しています... |   |
| 57% | ソースの代替コンピューター名を削除しています... |   ソースが他のユーザーとアプリに到達できないようにします。 詳細については、「 [Netdom computername](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/cc835082(v=ws.11))」を参照してください。 |
| 58% | ソースコンピューターに作成した一時ローカルアカウントを削除しています... |   |
| 61% | ソースコンピューターのローカルアカウントトークンフィルターポリシーをリセットしています... |   ポリシーを有効にします。|
| 63% | 対象のコンピューターをドメインから削除しています... |   |
| 66% | 対象コンピューターを再起動しています...(1 回目の再起動) |   |
| 69% | 1回目の再起動後に、対象のコンピューターが応答するのを待機しています... |   |
| 72% | 対象コンピューターのネットワークインターフェイスをマップしています... |  は、各ネットワークアダプターと IP アドレスを、移行元コンピューターから移行先コンピューターにマップし、宛先のネットワーク情報を置き換えます。   |
| 75% | 対象のコンピューターの名前を変更しています... |   |
| 77% | 対象のコンピューターをドメインに追加しています... |  対象のコンピューターは、古いソースコンピューターの Active Directory オブジェクトを引き継ぎます。 これは、対象ユーザーが Domain Admins のメンバーでない場合、またはソースコンピューター Active Directory オブジェクトに対する管理者権限がない場合に失敗することがあります。 再運用を開始する前に、[資格情報の入力] ステップで代替の送信先資格情報を指定できます。|
| 80% | 対象コンピューターを再起動しています...(1 回目の再起動) |   |
| 83% | 対象コンピューターを再起動しています...(2 回目の再起動) |   |
| 84% | 対象のコンピューターが応答するのを待機しています... |   |
| 86% | 1回目の再起動後に、対象のコンピューターが応答するのを待機しています... |   |
| 88% | 2回目の再起動後に、対象のコンピューターが応答するのを待機しています... |   |
| 91% | 対象のコンピューターが新しい名前で応答するのを待機しています... |  Active Directory と DNS のレプリケーションにより、時間がかかることがあります。 |
| 93% | 転送先の別のコンピューター名を削除しています... |   コピー先の名前が置き換えられていることを確認します。|
| 94% | 対象のコンピューターで作成した一時ローカルアカウントを削除しています...|   |
| 97% | 対象コンピューターのローカルアカウントトークンフィルターポリシーをリセットしています... |   ポリシーを有効にします。|
| (100%) | 成功 |   |

## <a name="faq"></a>よく寄せられる質問

### <a name="__is-domain-controller-migration-supported__"></a>__ドメインコントローラーの移行はサポートされていますか?__

現時点ではありませんが、回避策については、 [FAQ のページ](./faq.md#is-domain-controller-migration-supported) を参照してください。


## <a name="known-issues"></a>既知の問題
>記憶域移行サービスの [概要](overview.md) に関する要件を満たしていること、および記憶域移行サービスを実行しているコンピューターに最新の Windows update がインストールされていることを確認します。

次の問題の詳細については、[ [既知の問題] ページ](./known-issues.md) を参照してください。
* [__記憶域移行サービスの切り替えの検証が、"対象コンピューターのトークンフィルターポリシーのアクセスが拒否されました" というエラーで失敗する__](./known-issues.md#storage-migration-service-cutover-validation-fails-with-error-access-is-denied-for-the-token-filter-policy-on-destination-computer)

* [__"ネットリソースに対する CLUSCTL_RESOURCE_NETNAME_REPAIR_VCO に失敗しました" というエラーが発生し、Windows Server 2008 R2 クラスターのカットオーバーが失敗する__](./known-issues.md#error-clusctl_resource_netname_repair_vco-failed-against-netname-resource-and-windows-server-2008-r2-cluster-cutover-fails)

* [__"38% のソースコンピューターのネットワークインターフェイスのマッピングが停止しています..."静的 Ip を使用する場合__](./known-issues.md#cutover-hangs-on-38-mapping-network-interfaces-on-the-source-computer-when-using-static-ips)

* [__"38% のソースコンピューターのネットワークインターフェイスのマッピングが停止しています..."__](./known-issues.md#cutover-hangs-on-38-mapping-network-interfaces-on-the-source-computer)

## <a name="additional-references"></a>その他のリファレンス

- [記憶域移行サービスの概要](overview.md)
- [記憶域移行サービスを使用してファイルサーバーを移行する](migrate-data.md)
- [記憶域移行サービスに関してよく寄せられる質問 (FAQ)](faq.md)
- [記憶域移行サービスの既知の問題](known-issues.md)