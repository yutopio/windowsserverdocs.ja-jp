---
title: RD 接続ブローカー サーバーを追加して RDS で高可用性を構成する
description: 高可用性のために RDS の展開に RD 接続ブローカーを追加する方法について説明します。
ms.author: elizapo
ms.date: 04/10/2017
ms.topic: article
author: lizap
manager: dongill
ms.openlocfilehash: 1e33017eb7d105a9d53d9e34f828a953d8c527fa
ms.sourcegitcommit: 39d55b5a0006aceac6281e8cdb61fc79a209ce1b
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/04/2020
ms.locfileid: "93328122"
---
# <a name="add-the-rd-connection-broker-server-to-the-deployment-and-configure-high-availability"></a>RD 接続ブローカー サーバーを展開に追加し、高可用性を構成する

> 適用先:Windows Server (半期チャネル)、Windows Server 2019、Windows Server 2016

リモート デスクトップ サービス インフラストラクチャの可用性と規模を向上させるために、リモート デスクトップ接続ブローカー (RD 接続ブローカー) クラスターを展開することができます。

## <a name="pre-requisites"></a>前提条件

2 つ目の RD 接続ブローカーとして機能するサーバーをセットアップします。これは物理サーバーまたは VM のどちらでもかまいません。

接続ブローカー用のデータベースをセットアップします。 [Azure SQL Database](/azure/azure-sql/database/single-database-create-quickstart#create-a-new-aure-sql-database) インスタンスまたはローカル環境の SQL Server を使用できます。 以下では Azure SQL を使用する方法について説明しますが、手順は SQL Server にも当てはまります。 データベースの接続文字列を見つけて、正しい ODBC ドライバーを用意していることを確認する必要があります。

## <a name="step-1-configure-the-database-for-the-connection-broker"></a>手順 1:接続ブローカー用のデータベースを構成する

1. 作成したデータベースの接続文字列を見つけます。これは、ODBC ドライバーのバージョンを識別するためと、後で接続ブローカー自体を構成しているとき (手順 3) の両方のために必要なので、簡単に参照できるどこかに文字列を保存します。 以下に、Azure SQL の接続文字列を見つける方法を示します。
    1. Azure portal で、 **[参照] > [リソース グループ]** をクリックし、デプロイ用のリソース グループをクリックします。
    2. 作成したばかりの SQL データベース (たとえば CB-DB1) を選択します。
    3. **[設定]**  >  **[プロパティ]**  >  **[データベース接続文字列の表示]** の順にクリックします。
    4. **ODBC (Node.js を含む)** の接続文字列をコピーします。次のように見えるはずです。

        ```
        Driver={ODBC Driver 13 for SQL Server};Server=tcp:cb-sqls1.database.windows.net,1433;Database=CB-DB1;Uid=sqladmin@contoso;Pwd={your_password_here};Encrypt=yes;TrustServerCertificate=no;Connection Timeout=30;
        ```

    5. "Your_password_here" を実際のパスワードに置き換えます。 データベースへの接続時に、自分のパスワードを含めてこの文字列全体を使用します。
2. 新しい接続ブローカーに ODBC ドライバーをインストールします。
    1. 接続ブローカーのために VM を使用する場合は、最初の RD 接続ブローカー用にパブリック IP アドレスを作成します。 (これを行う必要があるのは、RDMS 仮想マシンに、RDP 接続を可能にするパブリック IP アドレスがまだない場合だけです。)
        1. Azure portal で、 **[参照]**  >  **[リソース グループ]** とクリックし、デプロイのリソース グループをクリックしてから、RD 接続ブローカーの最初の仮想マシンをクリックします (たとえば Contoso-Cb1)。
        2. **[設定] > [ネットワーク インターフェイス]** の順にクリックして、対応するネットワーク インターフェイスをクリックします。
        3. **[設定] > [IP アドレス]** の順にクリックします。
        4. **[パブリック IP アドレス]** では、 **[有効]** を選択し、 **[IP アドレス]** をクリックします。
        5. 使用したい既存のパブリック IP アドレスがある場合は、一覧からそれを選択します。 それ以外の場合は、 **[新規作成]** をクリックし、名前を入力したら、 **[OK]** 、 **[保存]** の順にクリックします。
    2. 最初の RD 接続ブローカーに接続します。
        1. Azure portal で、 **[参照]**  >  **[リソース グループ]** とクリックし、デプロイのリソース グループをクリックしてから、RD 接続ブローカーの最初の仮想マシンをクリックします (たとえば Contoso-Cb1)。
        2. **[接続] > [開く]** とクリックしてリモート デスクトップ クライアントを開きます。
        3. クライアントで、 **[接続]** をクリックし、 **[別のユーザー アカウントを使用する]** をクリックします。 ドメイン管理者アカウントのユーザー名とパスワードを入力します。
        4. 証明書について警告されたら **[はい]** をクリックします。
    3. ODBC 接続文字列内のバージョンと一致する [SQL Server 用 ODBC ドライバー](https://www.microsoft.com/download/confirmation.aspx?id=50420)をダウンロードします。 上記の例の文字列の場合は、バージョン 13 の ODBC ドライバーをインストールする必要があります。
    4. 最初の RD 接続ブローカー サーバーに sqlincli.msi ファイルをコピーします。
    5. sqlincli.msi ファイルを開き、ネイティブ クライアントをインストールします。
    6. 追加の RD 接続ブローカー (たとえば Contoso-Cb2) ごとに手順 1 ～ 5 を繰り返します。
    7. 接続ブローカーを実行する各サーバーに ODBC ドライバーをインストールします。

## <a name="step-2-configure-load-balancing-on-the-rd-connection-brokers"></a>手順 2:RD 接続ブローカーで負荷分散を構成する

Azure インフラストラクチャを使用する予定の場合は、[Azure のロード バランサー](#create-a-load-balancer)を作成できます。そうでない場合は、[DNS ラウンド ロビン](#configure-dns-round-robin)をセットアップできます。

### <a name="create-a-load-balancer"></a>ロード バランサーを作成します
1. Azure のロード バランサーを作成します
    1. Azure portal で **[参照] > [ロード バランサー] > [追加]** の順にクリックします。
    2. 新しいロード バランサーの名前 (たとえば hacb) を入力します。
    3. **[スキーム]** には **[内部]** を、デプロイ (たとえば Contoso-VNet) には **[仮想ネットワーク]** を選択し、すべてのリソース (たとえば、既定値) を含む **サブネット** を選択します。
    4. **[IP アドレスの割り当て]** には **[静的]** を選択し、現在使用中でない **プライベート IP アドレス** (たとえば、10.0.0.32) を入力します。
    5. 適切な **サブスクリプション** 、すべてのリソースを含む **リソース グループ** 、および適切な **場所** を選択します。
    6. **[作成]** を選択します。
2. どのサーバーがアクティブであるかを監視するために[プローブ](/azure/load-balancer/load-balancer-custom-probe-overview)を作成します。
    1. Azure portal で、 **[参照] > [ロード バランサー]** の順にクリックし、作成したばかりのロード バランサー (たとえば CBLB) をクリックします。 **[設定]** をクリックします。
    2. **[プローブ] > [追加]** の順にクリックします。
    3. プローブの名前 (たとえば **RDP** ) を入力し、 **[プロトコル]** としては **[TCP]** を選択します。 **[ポート]** には「 **3389** 」と入力し、 **[OK]** をクリックします。
3. 接続ブローカーのバックエンド プールを作成します。
    1. **[設定]** で、 **[バックエンド アドレス プール] > [追加]** の順にクリックします。
    2. 名前 (たとえば CBBackendPool) を入力し、 **[仮想マシンの追加]** をクリックします。
    3. 可用性セット (たとえば CbAvSet) を選択し、 **[OK]** をクリックします。
    3. **[仮想マシンの選択]** をクリックし、各仮想マシンを選択してから、 **[選択] > [OK] > [OK]** の順にクリックします。
4. RDP の負荷分散規則を作成します。
    1. **[設定]** で、 **[負荷分散規則]** をクリックして、 **[追加]** をクリックします。
    2. 名前 (たとえば RDP) を入力し、 **[プロトコル]** には **[TCP]** を選択します。 **[ポート]** と **[バックエンド ポート]** の両方に「 **3389** 」と入力し、 **[OK]** をクリックします。
5. ロード バランサーの DNS レコードを追加します。
    1. RDMS サーバーの仮想マシン (たとえば Contoso-CB1) に接続します。 VM に接続する方法の手順については、[RD 接続ブローカーの VM の準備](./rds-prepare-vms.md)に関するページを参照してください。
    2. サーバー マネージャーで、 **[ツール] > [DNS]** とクリックします。
    3. 左側のウィンドウで **[DNS]** を展開し、DNS マシンをクリックします。 **[前方参照ゾーン]** をクリックしてから、ドメイン名 (たとえば Contoso.com) をクリックします。 (情報のために DNS サーバーに対するクエリを処理するのに数秒かかることがあります。)
    4. **[アクション] > [新しいホスト (A または AAAA)]** とクリックします。
    9. 名前 (たとえば、hacb) と、前に指定した IP アドレス (たとえば 10.0.0.32) を入力します。

### <a name="configure-dns-round-robin"></a>DNS ラウンド ロビンを構成する

次の手順は、Azure 内部ロード バランサーを作成する代わりになります。

1. Azure portal で RDMS サーバーに接続します。 リモート デスクトップ接続クライアントを使用します
2. DNS レコードを作成します。
    1. サーバー マネージャーで、 **[ツール] > [DNS]** とクリックします。
    2. 左側のウィンドウで **[DNS]** を展開し、DNS マシンをクリックします。 **[前方参照ゾーン]** をクリックしてから、ドメイン名 (たとえば Contoso.com) をクリックします。 (情報のために DNS サーバーに対するクエリを処理するのに数秒かかることがあります。)
    3. **[アクション]** 、 **[新しいホスト (A または AAAA)]** の順にクリックします。
    4. RD 接続ブローカー クラスターの **DNS 名** (たとえば、hacb) を入力し、最初の RD 接続ブローカーの **IP アドレス** を入力します。
    5. 追加する RD 接続ブローカーごとに手順 3 および 4 を繰り返して、追加のレコードごとに一意の IP アドレスを提供します。


たとえば、RD 接続ブローカーの 2 つの仮想マシンの IP アドレスが 10.0.0.8 と 10.0.0.9 である場合、2 つの DNS ホスト レコードを作成することになります。
- ホスト名: hacb.contoso.com、IP アドレス: 10.0.0.8
- ホスト名: hacb.contoso.com、IP アドレス: 10.0.0.9

## <a name="step-3-configure-the-connection-brokers-for-high-availability"></a>手順 3:高可用性のための接続ブローカーを構成する

1. 新しい RD 接続ブローカー サーバーをサーバー マネージャーに追加します。
    1. サーバー マネージャーで、 **[管理] > [サーバーの追加]** とクリックします。
    2. **[Find Now]** をクリックします。
    3. 新しく作成された RD 接続ブローカー サーバー (たとえば Contoso-Cb2) をクリックし、 **[OK]** をクリックします。
2. RD 接続ブローカーのために高可用性を構成します。
    1. サーバー マネージャーで、 **[リモート デスクトップ サービス] > [概要]** とクリックします。
    2. **[RD 接続ブローカー]** を右クリックし、 **[高可用性の構成]** をクリックします。
    3. 構成の種類のセクションが表示されるまでウィザードを進めます。 **[共有データベース サーバー]** を選択してから、 **[次へ]** をクリックします。
    4. RD 接続ブローカーのクラスターの DNS 名を入力します。
    5. SQL DB の接続文字列を入力してから、ウィザードのページを進めて高可用性を確立します。
3. デプロイに新しい RD 接続ブローカーを追加します
    1. サーバー マネージャーで、 **[リモート デスクトップ サービス] > [概要]** とクリックします。
    2. RD 接続ブローカーを右クリックし、 **[Add RD Connection Broker Server] (RD 接続ブローカー サーバーの追加)** をクリックします。
    3. [サーバーの選択] が表示されるまでウィザードのページを進めてから、新しく作成された RD 接続ブローカー サーバー (たとえば Contoso-CB2) を選択します。
    4. 既定値をそのまま使用してウィザードを完了します。
4. RD 接続ブローカーのサーバーおよびクライアントで、信頼できる証明書を構成します。
