---
description: 詳細については、「要求エンジンの役割」を参照してください。
ms.assetid: 8b15d44e-e4e6-4510-aa91-cc7ec7161b0a
title: 要求エンジンの役割
author: billmath
ms.author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.openlocfilehash: 1be762cefabdc40050e7656ec29033778b92bbf6
ms.sourcegitcommit: 65b6de6b44d41f1180c45db11cdd60cb2a093b46
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 12/10/2020
ms.locfileid: "97050490"
---
# <a name="the-role-of-the-claims-engine"></a>要求エンジンの役割
Active Directory フェデレーション サービスで要求エンジンの最上位のレベル、 \(AD FS\) ルール\-ベースのエンジンを提供していると、フェデレーション サービスの要求の要求の処理を行う専用です。 要求エンジンは、構成されたすべてのフェデレーション信頼関係に対する各規則セットの実行と、要求パイプラインへの出力結果の送信を単独で行う、フェデレーション サービス内のエンティティです。

要求パイプラインは、最後の論理概念より\-に\-クレームをフローさせるためのプロセスを終了、規則は次の要求規則の実行プロセス中の要求のフローのカスタマイズに使用できる実際の管理用の要素を要求します。 パイプライン プロセスの詳細については、「 [The Role of the Claims Pipeline](The-Role-of-the-Claims-Pipeline.md)」を参照してください。

次の図では、入力方向の要求を受け入れる場合の動作のように \(受け入れ規則\), 、依頼者の要求を承認する \(承認規則\) と出力方向の要求を発行 \(発行規則\) 要求を通じて、組織のフェデレーションの信頼関係のすべてのルールは要求エンジンによって実行されます。

![AD FS の役割](media/adfs2_enginepipeline.gif)

## <a name="claim-rules-execution-process"></a>要求規則の実行プロセス
要求規則と要求プロバイダー信頼または、組織内の証明書利用者信頼を構成する際に、要求規則が設定\(s\) 信頼および発行を要求する任意のクレームを発行するかどうかを判断する要求規則のために必要なロジックを適用する種類の要求を呼び出すことによって入力方向の要求のゲートキーパーとして機能します。

次のセクションでは、要求規則の実行プロセスでエンジンによって行われる要求処理の各ステップについて概要を説明します。 以下で説明する各ステップは、要求パイプライン プロセスで説明されているステージごとに発生します。 その手順は次のとおりです。

-   ステップ 1 - 初期化

-   ステップ 2 - 実行

-   ステップ 3 - 実行結果

パイプライン プロセスの詳細については、「 [The Role of the Claims Pipeline](The-Role-of-the-Claims-Pipeline.md)」を参照してください。

### <a name="step-1--initialization"></a>ステップ 1 - 初期化
要求規則実行プロセスの最初のステップでは、最初に要求エンジンが受信要求を *入力要求セット* に追加することにより、受信要求を受け入れます。 入力要求セットはメモリのキャッシュに似ており、必要なプロセスにおいてデータの取得が必要となる間だけ一時的にデータを格納します。 入力要求セットのデータは、規則の実行が完了すると破棄されます。

#### <a name="adding-a-claim-to-the-input-claim-set-for-a-rule-set"></a>規則セットの入力要求セットへの要求の追加
入力要求セットは、ある要求規則セットに関連付けられたロジックを処理するときに要求データをメモリに一時的に保存しておく必要がある場合に、要求エンジンによって作成されます。 要求エンジンによってすべての受信要求が入力要求セットにコピーされ、そこから規則セットの最初の規則が受信要求を取得します。

たとえば、下の図の要求エンジンは、受信要求から要求 A および B を読み取り、入力要求セットにコピーします。 入力要求セットに要求が追加されると、要求エンジンは、要求規則セット内の最初の規則のロジックの入力として、要求 A および B を取得して処理します。

![AD FS の役割](media/adfs2_context1.gif)

要求規則セット内のすべての規則は、同じ入力要求セットを共有します。 要求規則セット内の各規則は共有の入力要求セットに要求を追加することができ、セット内のすべての後続の規則が影響を受けます。

### <a name="step-2--execution"></a>ステップ 2 - 実行
要求規則プロセスのこのステップでは、要求規則が処理されます。このとき要求エンジンは、特定の規則セット内のすべての規則を 1 つずつ古い順に処理します。 ルール セットのみに含まれる各規則に実行され、表示される上から下に、AD FS 管理スナップインの [要求規則の編集] ダイアログ ボックスに表示される順序で実行される\-にします。 規則セットの一番上にある要求規則が最初に処理された後、すべての規則が実行されるまで、後続の規則が順番に処理されます。

要求規則言語で定義されているとおり、要求規則は、条件と発行ステートメントの 2 つの部分で構成されます。 要求エンジンは、まず入力要求セットのデータを使用して条件部分を処理し、規則内で指定された条件が、入力要求セットに含まれる要求に対して true を保持するかどうかを判断し \( ます。これは、規則の条件に一致する要求が一致要求として参照され \) ます。 一致要求が見つかると、要求エンジンは、一致要求の各セットに対して規則の発行ステートメントを実行します。 規則の発行ステートメントは、一致要求を使用して、以下のタスクのいずれかを実行できます。

1.  一致要求を出力要求セットにコピーする。

2.  要求の各フィールドを変換して、入力要求セットだけ、または評価要求セットと出力要求セットの両方に新しい要求を作成する。

3.  一致するクレームを使用して\(s\) 新しいクレームを作成する属性ストアから詳細情報を参照するためにキーとして\(s\) クレーム セットをクレームまたはクレーム セットを両方の入力し、出力で入力だけでできます。

#### <a name="adding-a-claim-to-the-output-claim-set-for-a-rule-set"></a>規則セットの出力要求セットへの要求の追加
*出力要求セット* はメモリ内の場所で、最初は何も含まれていませんが、実行プロセスが完了すると要求エンジンは出力要求セットに存在する要求だけを返すため、重要な存在です。 つまり、最終的な送信要求のセットを計算する段階になると、入力要求セットだけに存在して出力要求セットに存在しない要求は無視されます。

#### <a name="adding-a-claim-to-both-claim-sets-for-a-rule-set"></a>規則セットの両方の要求セットへの要求の追加
規則が処理されると、要求は、規則の発行ステートメントで使用されているステートメントに基づいて、入力要求セットまたは入力要求セットと出力要求セットの両方に追加されます。 要求規則言語では、これらのステートメントを *add* または *issue* と呼びます。

*add* ステートメントを使用する場合、要求は、入力要求セットだけに追加されます。要求は実行のみを目的として存在し、実行が完了すると失われます。 *issue* ステートメントを使用する場合、要求は入力要求セットと出力要求セットの両方に追加され、実行が完了すると、出力要求セットに返されます。 これらのステートメントの詳細については、次を参照してください。 [要求規則言語の役割](The-Role-of-the-Claim-Rule-Language.md)します。

規則セット内の規則の条件部分が入力要求セット内のいずれの要求とも一致しない場合、規則の発行ステートメント部分は無視されます。したがって、出力要求セットにも入力要求セットにも要求は追加されません。 次の図と対応する各ステップで、要求エンジンが変換規則を実行する際の手順を説明します。

![AD FS の役割](media/adfs2_context2.gif)

1.  要求エンジンによって受信要求が入力要求セットに追加されます。

2.  最初の規則が実行されると、要求 A および B が調べられ (この時点では、この 2 つの要求だけが入力要求セットに格納されています)、規則 1 の規則ロジックの条件部分が処理されます。

3.  A の要求は、入力クレーム セットで、あるために、true を指定するルールの条件が決定されます。 \(クレーム A に一致する\) され、クレーム セットの両方に、入力と出力クレーム セットに新しい C クレームを追加します。

4.  ルール 2 では、A、B および C のクレームを使用できるようになりました \(入力内のすべてのクレームのクレーム セット\) そのロジックを処理するための入力として。

要求変換の詳細については、「 [When to Use a Transform Claim Rule](When-to-Use-a-Transform-Claim-Rule.md)」を参照してください。

### <a name="step-3--execution-result"></a>ステップ 3 - 実行結果
要求規則セットの実行の最終ステージは、特定の規則セット内のすべての規則が実行され、最終的な要求セットが出力要求セットに格納された時点で開始されます。 この時点で、要求エンジンは、出力要求セットのコンテキストを規則セット実行の出力として返します。 この時点以降は、要求パイプラインがこの最終的な出力を受け取り、プロセスの次のステージに送ります。

## <a name="sending-the-execution-output-to-the-claims-pipeline"></a>要求パイプラインへの実行の出力の送信
要求エンジンが規則セットを処理する際、その規則セットの入力および出力要求セット用として、メモリ内に専用の場所が用意されます。 つまり、ある規則セットによって使用される入力/出力要求セットは、別の規則セットの入力/出力要求セットとは切り離されています。

プロセス全体を指定します。 ルール セットの実行後 \(ステップ 1、2、3\), 、出力方向の要求を新しく発行された \(出力のコンテンツのクレーム セット\) 要求パイプラインで設定する次の規則への入力として使用されます。 これにより、次の図のように、要求を 1 つの規則セットの出力から別の規則セットの入力へと送ることができます。

![AD FS の役割](media/adfs2_enginecontexts.gif)

> [!NOTE]
> 発行規則セットもパイプラインにおける重要なステージですが、上の図では簡略化のために示されていません。 発行のルール セットおよび要求パイプラインに組み込む方法を示す図解は、次を参照してください。 [要求パイプラインの役割](The-Role-of-the-Claims-Pipeline.md)します。

このケースでは、パイプラインは受け入れ規則の出力を使用して、受け入れ規則によって生成された最終的な要求セットを、承認規則の処理を行うパイプラインの第 2 ステージに送っています。 全体要求規則の実行プロセスの時点では、 \(手順 1、2、および上記の 3\) 承認規則のセットをもう一度実行します。 このサイクルは発行規則が設定されるまで \(パイプラインの最後のステージ\) が完了しました。

完成した送信要求は、発行規則セットのエンジンから返されると SAML トークンにパッケージ化され、そのトークンがフェデレーション サービスによってクライアントに送り返されます。

## <a name="processing-authorization-rules"></a>承認規則の処理
要求規則の実行プロセスの手順 2. で実行されている要求規則セットが、受け入れ規則 \( または発行規則とは異なる入力および出力要求セットを持つ承認規則で構成されている場合は、これらの承認規則を実行して、要求 \) 元の要求に基づいてフェデレーションサービス、特定の証明書利用者のセキュリティトークンを取得する権限がトークンの要求

承認規則の目的は、ユーザーが特定の証明書利用者に対するトークンの取得を許可されるかどうかに基づいて、許可または拒否要求を発行することにあります。 発行ルール セットを実行するかどうかを決定する承認の実行の出力がパイプラインによって使用次の図に示すように-許可の有無に基づいてと\/または要求を拒否する — が自体の承認の実行の出力が要求規則のセットへの入力として使用されていません。

![AD FS の役割](media/adfs2_authorization.gif)

要求承認の詳細については、「 [When to Use an Authorization Claim Rule](When-to-Use-an-Authorization-Claim-Rule.md)」を参照してください。


