---
ms.assetid: 68db7f26-d6e3-4e67-859b-80f352e6ab6a
title: AD FS 構成データベースの役割
description: AD FS の1つのインスタンスを表す構成データをすべて格納するための構成データベースの役割について説明します。
author: billmath
ms.author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.openlocfilehash: 7adcd3a62ff85167172fcd856a3214fb51d9bd0b
ms.sourcegitcommit: f95a991491ff09260d979078e248e2636bd2db54
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 12/10/2020
ms.locfileid: "96997839"
---
# <a name="the-role-of-the-ad-fs-configuration-database"></a>AD FS 構成データベースの役割
AD FS 構成データベースには、Active Directory フェデレーションサービス (AD FS) AD FS の1つのインスタンスを表すすべての構成データ \( \) \( (フェデレーションサービス) が格納され \) ます。 AD FS 構成データベースでは、フェデレーション サービスは、パートナー、証明書、属性ストア、要求、およびこれらの関連エンティティに関するさまざまなデータを識別するために必要なパラメーターのセットを定義します。 この構成データは、 &reg; \( \) windows Server 2012 以降に含まれている Microsoft SQL Server データベースまたは windows Internal database WID 機能のいずれかに格納できます。

> [!NOTE]
> AD FS 構成データベースの内容全体ができるは、WID のインスタンスまたは SQL データベースのインスタンス ストアドは両方は必要ありません。 つまり、WID と AD FS 構成データベースの同じインスタンスの SQL Server データベースを使用して他のユーザーを使用していくつかのフェデレーション サーバーを持つことはできません。

指定されたコンテンツと共にこのトピックで、次の情報を使用する [AD FS 展開トポロジに関する考慮事項](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/gg982489(v=ws.11)) 長所と短所を AD FS 構成データベースを格納する WID または SQL Server を選択した場合の詳細については。

WID リレーショナル データ ストアを使用し、管理ユーザー インターフェイスを持たない \(UI\)します。 代わりに、管理者は、AD FS 管理スナップイン \- 、Fsconfig.exe、または Windows PowerShell コマンドレットを使用して、AD FS 構成データベースの内容を変更でき &trade; ます。

## <a name="using-wid-to-store-the-ad-fs-configuration-database"></a>WID を使用して AD FS 構成データベースを保存する
いずれかを使用して、ストアとして WID を使用して AD FS 構成データベースを作成すると、Fsconfig.exe コマンド\-ライン ツールまたは AD FS フェデレーション サーバー構成ウィザード。 これらのツールを使用する場合、フェデレーション サーバー トポロジを作成するために次のいずれかのオプションを選択できます。 これらの各オプションでは、WID を使用して、AD FS 構成データベースを格納するため。

-   作成、スタンド\-だけでフェデレーション サーバー

-   フェデレーション サーバー ファーム内に最初のフェデレーション サーバーを作成する

-   フェデレーション サーバー ファームにフェデレーション サーバーを追加する

スタンドを選択した場合\-AD FS 構成データベースの単一のインスタンスを格納するだけでオプション、WID を使用します。 このインスタンスを複数のフェデレーション サーバーで共有することはできません。 これはテスト ラボ環境向けのオプションです。 スタンドアロンの詳細については\-単独で、フェデレーション サーバーのオプションまたはいずれかを設定する方法を参照してください。 [WID を使用してフェデレーション サーバーをスタンドアロン](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/gg982486(v=ws.11)) または [スタンドアロン フェデレーション サーバーを作成](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/ee913579(v=ws.11))します。

フェデレーション サーバー ファームに最初のフェデレーション サーバーを作成するオプションを選択した場合、後からファームに別のフェデレーション サーバーを追加できるように、WID でスケーラビリティが構成されます。 WID ファームの展開に関する詳細とセットアップ方法については、「[WID を使用したフェデレーション サーバー ファーム](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/gg982492(v=ws.11))」または「[フェデレーション サーバー ファームに最初のフェデレーション サーバーを作成する](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dd807070(v=ws.11))」を参照してください。

フェデレーション サーバーを追加するオプションを選択した場合、指定した間隔で構成データベースの変更点が新しいフェデレーション サーバーにレプリケートされるように WID が構成されます。 WID ファームへのフェデレーション サーバーの追加に関する詳細については、「[WID を使用するフェデレーション サーバー ファーム](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/gg982492(v=ws.11))」または「[フェデレーション サーバー ファームにフェデレーション サーバーを追加する](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/ee913575(v=ws.11))」を参照してください。

> [!NOTE]
> WID を使用するフェデレーション サーバー ファームを展開するときに AD FS の一部の機能は利用できません。 完全な機能セット、サーバー ファームを構成するときにアクセスするにはには、代わりに、AD FS 構成データベースを格納する Microsoft SQL Server の使用を検討します。 詳細については、「[AD FS 展開トポロジに関する考慮事項](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/gg982489(v=ws.11))」を参照してください。

### <a name="how-a-wid-federation-server-farm-works"></a>WID フェデレーション サーバー ファームの動作
このセクションでは、WID フェデレーション サーバー ファームのプライマリおよびセカンダリ フェデレーション サーバー間でデータがレプリケートされる仕組みを理解する上で重要な概念を説明します。 .

#### <a name="primary-federation-server"></a>プライマリ フェデレーション サーバー
プライマリフェデレーションサーバーは、Windows Server 2012 以降を実行しているコンピューターで、AD FS フェデレーションサーバー構成ウィザードを使用してフェデレーションサーバーの役割を構成し、AD FS 構成データベースの読み取り/書き込みコピーを持つコンピューターです。 AD FS フェデレーション サーバー構成ウィザードを使用して、新しいフェデレーション サービスを作成し、そのコンピューターに、ファーム内の最初のフェデレーション サーバーを作成するオプションを選択すると、プライマリ フェデレーション サーバーは常に作成されます。 セカンダリ フェデレーション サーバーとも呼ばれるこのファーム内の他のすべてのフェデレーション サーバーは、ローカルに格納されている AD FS 構成データベースのコピーをプライマリ フェデレーション サーバーに対して行われた変更を同期する必要があります。

#### <a name="secondary-federation-servers"></a>セカンダリ フェデレーション サーバー
セカンダリ フェデレーション サーバー、プライマリ フェデレーション サーバーから AD FS 構成データベースのコピーを保存するが、これらのコピーは読み取り\-のみです。 セカンダリ フェデレーション サーバーは、ファーム内のプライマリ フェデレーション サーバーに接続し、一定間隔でサーバーをポーリングしてデータが変更されたかどうかをチェックすることにより、プライマリとデータを同期します。 セカンダリ フェデレーション サーバーの存在を読み込むには、機能している間、プライマリ フェデレーション サーバーにフォールト トレランスを提供する\-ネットワーク環境のさまざまなサイトで行われるアクセス要求を分散します。


#### <a name="how-the-ad-fs-configuration-database-is-synchronized"></a>AD FS 構成データベースを同期する方法
により、AD FS 構成データベースが果たす重要な役割、入手可能には、ネットワーク内のすべてのフェデレーション サーバーでフォールト トレランスと負荷を行います\-要求を処理するときに、分散機能 \(とネットワーク負荷\-バランサーが使用される\)します。 ただし、この機能で処理するためにセカンダリ フェデレーション サーバーでは、プライマリ フェデレーション サーバーに格納されている AD FS 構成データベースを同期する必要があります。

フェデレーション サーバーをファームに追加すると、セカンダリ フェデレーション サーバーとなる新しいコンピューターは、AD FS 構成データベースのコピーをレプリケートするプライマリ フェデレーション サーバーに接続します。 これ以降、新しいフェデレーション サーバーは、次の図に示すように定期的にプライマリ フェデレーション サーバーから更新を取得し続けます。

![AD FS の役割](media/adfs2_WID.png)

各セカンダリ フェデレーション サーバーでは、5 分間隔の変更で、プライマリ フェデレーション サーバーをポーリングします。 この既定値 5 を調整する\-値を分単位または強制的に即時同期はいつでも Windows PowerShell コマンドレットを使用しています。 これを行う方法の詳細については、次を参照してください。 [Windows PowerShell による AD FS の管理](https://go.microsoft.com/fwlink/?LinkID=179634)します。

WID の同期プロセスでは、中程度の変更をより効率的に転送できるように増分転送もサポートされています。 増分転送プロセスでは、必要なネットワーク トラフィックを大幅に削減でき、転送が完了するまでの時間を大幅に短縮できます。

> [!NOTE]
> SQL Server のインスタンスに WID を AD FS 構成データベースの移行をサポートするとします。 これを行う方法の詳細については、次を参照してください。 [AD FS: AD FS 構成データベースを SQL Server に移行](https://go.microsoft.com/fwlink/?LinkId=192232) 、TechNet Wiki サイトにします。

### <a name="how-to-managed-the-ad-fs-synchronization-properties"></a>AD FS の同期プロパティを管理する方法
このセクションでは、AD FS 構成データベース同期ないを表示および編集する方法について説明します。
.

**ADFSSyncProperties** コマンドレットは、Active Directory フェデレーションサービス (AD FS) (AD FS) の構成データベースの同期プロパティを取得します。

```
PS C:\> Get-ADFSSyncProperties
```
プライマリ AD FS サーバーでは、このコマンドレットは、ロールがプライマリコンピューターであることのみを示します。 セカンダリメンバーでは、プライマリコンピューターからの最後の同期の完全な Quallified ドメイン名、最後の同期の状態と時刻、ポーリングの期間、現在構成されているプライマリ computername、プライマリコンピューターのポート、セカンダリコンピューターの役割を含む、構成の残りの部分が表示されます。

**ADFSSyncProperties** コマンドレットは、Active Directory フェデレーションサービス (AD FS) (AD FS) 構成データベースの同期の頻度を変更します。
また、このコマンドレットでは、フェデレーションサーバーファーム内のプライマリサーバーとなるフェデレーションサーバーも指定します。

> [!NOTE]
> プライマリ フェデレーション サーバーがクラッシュしてオフラインになった場合でも、すべてのセカンダリ フェデレーション サーバーは通常どおり要求を処理し続けます。 ただし、プライマリ フェデレーション サーバーがオンライン状態に戻るまで、フェデレーション サービスに新たに変更を加えることはできません。 セカンダリ フェデレーション サーバーを Windows PowerShell を使用して、プライマリ フェデレーション サーバーを指定できます。 新しいプライマリサーバーを指名する場合は、新しいプライマリサーバーを反映するようにサーバーを変更する必要があります。 WID ファームに2つのプライマリがあると、ファームの stableness に影響し、データを失う passibility が生じます。

#### <a name="modify-the-poll-duration-for-a-farm"></a>ファームのポーリング期間の変更
```
PS C:\> Set-AdfsSyncProperties -PollDuration 3600 -PrimaryComputerName "FederationServerPrimary"
```

このコマンドにより、データベースの同期が3600秒に変更されます。
このコマンドにより、プライマリフェデレーションサーバーが変更されます。

####  <a name="change-a-server-from-secondary-to-primary"></a>サーバーをセカンダリからプライマリに変更する
```
PS C:\> Set-AdfsSyncProperties -Role "PrimaryComputer"
```

このコマンドは、WID ファームの AD FS サーバーをセカンダリからプライマリに変更します。

#### <a name="change-a-primary-server-to-a-secondary-server"></a>プライマリサーバーをセカンダリサーバーに変更する
```
PS C:\> Set-AdfsSyncProperties -Role "SecondaryComputer" -PrimaryComputerName "<FQDN of primary server>"
```

このコマンドは、WID ファームのプライマリ AD FS サーバーをセカンダリサーバーに変更します。 プライマリサーバーの完全修飾ドメイン名を指定する必要があります。 そうしないと、すべてのセカンダリ AD FS サーバーが正常に同期されない可能性があります。
注: プライマリサーバーは、セカンダリサーバーからのポート80で HTTP 経由でアクセスできる必要があります。

詳細については[、「AdfsSyncProperties](https://docs.microsoft.com/powershell/module/adfs/set-adfssyncproperties?view=win10-ps) 」を参照してください。


## <a name="using-sql-server-to-store-the-ad-fs-configuration-database"></a>SQL Server を使用して AD FS 構成データベースを保存する
Fsconfig.exe コマンドを使用して、ストアとして 1 つの SQL Server データベース インスタンスを使用して AD FS 構成データベースを作成する\-ライン ツールです。 AD FS 構成データベースとして SQL Server database を使用すると、wid と比較次の利点が提供されます。

-   管理者は SQL Server の高可用性機能を活用できます

-   高トラフィック時のパフォーマンスがさらに向上します

-   次に示す saml アーティファクト解決と SAML/WS \- フェデレーショントークンリプレイ検出の機能サポートを提供 \( \) します。

次の図に示すように、すべてのフェデレーションサーバーが同じクラスター化された SQL Server インスタンスを使用している AD FS 構成データベースに対して同じように読み取りおよび書き込みを行うことができるため、"プライマリフェデレーションサーバー" という用語は、AD FS 構成データベースが SQL database インスタンスに格納されている場合には適用されません。

![AD FS の役割](media/adfs2_SQL.png)

SQL Server を使用して、AD FS にできるは、受信クライアント要求をサービスに高可用性サーバー クラスターとして連携して動作するのに 2 つ以上のサーバーを構成します。 高可用性を提供するスケール\-アウト アーキテクチャの他のサーバーを追加することによってサーバー容量を増やすことができます。 単一障害点は自動的なクラスター フェールオーバーによって軽減されます。

ネットワーク負荷を使用して高可用性を実現できます\-SQL クラスタ リング テクノロジを提供する分散とフェールオーバーのサービスです。 高可用性のために SQL Server を構成する方法の詳細については、「 [高可用性ソリューションの概要](https://go.microsoft.com/fwlink/?LinkId=179853)」を参照してください。

### <a name="saml-artifact-resolution"></a>SAML アーティファクト解決
Security Assertion Markup Language \(SAML\) アーティファクト解決は、要求プロバイダーから直接、証明書利用者がトークンを取得する方法について説明する SAML 2.0 プロトコルの一部に基づいたエンドポイントです。 解決プロセスの最初の段階では、ブラウザー クライアントがリソース フェデレーション サーバーに接続してアーティファクトを提供します。 第 2 段階では、リソース フェデレーション サーバーが、アカウント パートナー組織でホストされている SAML アーティファクト エンドポイント URL にアーティファクトを送信して、アーティファクト メッセージを解決します。 最終段階では、アカウント フェデレーション サーバーがブラウザー クライアントの代わりにトークンをフェデレーション サーバーに発行します。

> [!NOTE]
> アカウントパートナー組織の管理者は、Windows ルート証明書プログラムのメンバーのルート証明書にチェーンされている SSL 証明書を、 \( <ComputerName> \\ \\ \\ \\ ファーム内のすべてのアカウントフェデレーションサーバー上の [IIS サイトの既定の web サイト adfs ls] のフェデレーションパッシブ Web サイトに割り当てまたはバインドする必要が \) あります。 これは、リソース フェデレーション サーバーで SSL 証明書を [ローカル コンピューター] の [信頼されたユーザー] 証明書ストアに手動で追加する必要が生じたり、組織で公開されているアーティファクトを解決できなくなったりすることを避けるために重要です。

### <a name="samlws---federation-token-replay-detection"></a>SAML/WS-FEDERATION トークンリプレイ検出
*トークン リプレイ* という用語は、アカウント パートナー組織内のブラウザー クライアントが、リソース フェデレーション サーバーで認証するために、アカウント フェデレーション サーバーから受け取った同じトークンの送信を何度も試行する動作を指します。  この動作は、ユーザーが認証ページを再送信する目的でブラウザーの **[戻る]** ボタンをクリックしたときに発生します。

AD FS の *トークン リプレイ検出* という機能を使用すると、同じトークンを使用する複数のトークン要求を検出して破棄することができます。 トークン リプレイ検出が、両方の WS で認証要求の整合性を保護するこの機能を有効にすると、\-フェデレーション パッシブ プロファイルと同じトークンが複数回使用されることを確認することによって、SAML WebSSO プロファイル。 キオスクを使用する場合など、セキュリティが非常に重要な懸念事項になる状況では、この機能を有効にする必要があります。

キオスクの場合、ユーザーがすべての Web サイトからログオフした後で、悪意のあるユーザーがブラウザーの履歴を使用して前のユーザーが読み込んだフェデレーション認証ページを再送信しようとすることが考えられます。 トークン リプレイ検出機能は、アカウント パートナー組織で正常に完了した認証に関する追加情報を保存することで、後続のトークンのリプレイを検出して複数回の認証試行が成功しないようにして、この問題を軽減します。
