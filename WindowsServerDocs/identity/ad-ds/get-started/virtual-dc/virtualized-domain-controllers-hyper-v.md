---
title: Hyper-v を使用してドメインコントローラーを仮想化する
description: Hyper-v で Windows Server Active Directory ドメインコントローラーを仮想化する場合の考慮事項
author: iainfoulds
ms.author: daveba
ms.date: 04/19/2018
ms.topic: article
ms.openlocfilehash: cb01ef2c7a483b1160e68ea34ef38de67f7ff581
ms.sourcegitcommit: b115e5edc545571b6ff4f42082cc3ed965815ea4
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/30/2020
ms.locfileid: "93068174"
---
# <a name="virtualizing-domain-controllers-using-hyper-v"></a>Hyper-v を使用してドメインコントローラーを仮想化する

> 適用先:Windows Server 2016

このトピックは、Windows Server 2016 に適用できるガイダンスを作成するために更新されます。 Windows Server 2012 では、仮想 Dc の USN ロールバックを防止するためのセーフガードや、仮想 Dc を複製する機能など、仮想化ドメインコントローラー (Dc) に対する多くの機能強化が導入されています。 これらの機能強化の詳細については、「 [Active Directory Domain Services (AD DS) の仮想化 (レベル 100) の概要」を](../../introduction-to-active-directory-domain-services-ad-ds-virtualization-level-100.md)参照してください。

Hyper-v では、異なるサーバーの役割を1台の物理コンピューターに統合します。 このガイドでは、32ビットまたは64ビットのゲストオペレーティングシステムとしてのドメインコントローラーの実行について説明します。

## <a name="planning-to-virtualize-domain-controllers"></a>ドメインコントローラーの仮想化の計画

このセクションでは、Hyper-v サーバーのハードウェア要件、単一障害点を回避する方法、Hyper-v サーバーと仮想マシンに適した構成の種類を選択する方法、およびセキュリティとパフォーマンスに関する決定事項について説明します。

## <a name="hyper-v-requirements"></a>Hyper-V の要件

Hyper-v の役割をインストールして使用するには、次のものが必要です。

   - **X64 プロセッサ**
      - Hyper-v は、x64 ベースバージョンの Windows Server 2008 以降で使用できます。
   - **ハードウェア依存の仮想化**
      - この機能は、仮想化オプション、特に Intel Virtualization テクノロジ (Intel VT) または AMD Virtualization (AMD-V) を含むプロセッサで使用できます。
   - **ハードウェアデータ実行保護 (DEP)**
      - ハードウェア DEP が使用可能であり、有効になっている必要があります。 具体的には、Intel XD ビット (execute disable bit) または AMD NX ビット (no execute bit) を有効にする必要があります。

## <a name="avoid-creating-single-points-of-failure"></a>単一障害点の作成を回避する

仮想ドメインコントローラーの展開を計画するときに、潜在的な単一障害点を作成しないようにする必要があります。 システムの冗長性を実装することで、潜在的な単一障害点を導入することを回避できます。 たとえば、管理コストが増加する可能性を考慮しながら、次の推奨事項を検討してください。

1. 異なる仮想化ホスト上のドメインごとに少なくとも2つの仮想化ドメインコントローラーを実行すると、単一の仮想化ホストで障害が発生した場合に、すべてのドメインコントローラーが失われるリスクが軽減されます。
2. 他のテクノロジで推奨されているように、ドメインコントローラーが実行されているハードウェア (異なる Cpu、マザーボード、ネットワークアダプター、またはその他のハードウェアを使用) を展開します。 ハードウェア分散は、ベンダーの構成、ドライバー、または1つまたは複数の種類のハードウェアに固有の誤動作によって発生する可能性のある損害を制限します。
3. 可能であれば、ドメインコントローラーは、世界各地のさまざまな地域に配置されているハードウェア上で実行する必要があります。 これにより、ドメインコントローラーがホストされているサイトに影響を与える障害や障害の影響を軽減することができます。
4. 各ドメインで物理ドメインコントローラーを維持します。 これにより、そのプラットフォームを使用するすべてのホストシステムに影響する仮想化プラットフォームの誤動作のリスクが軽減されます。

## <a name="security-considerations"></a>セキュリティに関する考慮事項

仮想ドメインコントローラーが実行されているホストコンピューターは、ドメインに参加しているかワークグループのコンピューターである場合でも、書き込み可能なドメインコントローラーとして慎重に管理する必要があります。 これは、セキュリティに関する重要な考慮事項です。 Mismanaged ホストは、悪意のあるユーザーがアクセスを取得し、承認または正当に割り当てられていないシステム特権を取得した場合に発生する、特権の昇格攻撃に対して脆弱です。 悪意のあるユーザーがこの種の攻撃を使用して、このコンピューターがホストするすべての仮想マシン、ドメイン、およびフォレストを侵害する可能性があります。

ドメインコントローラーを仮想化する予定の場合は、次のセキュリティの考慮事項に留意してください。

   - 仮想書き込み可能なドメインコントローラーをホストするコンピューターのローカル管理者は、これらのドメインコントローラーが属しているすべてのドメインおよびフォレストの既定のドメイン管理者の資格情報と同等であると見なす必要があります。
   - セキュリティとパフォーマンスの問題を回避するための推奨構成は、Windows Server 2008 以降の Server Core インストールを実行しているホストであり、Hyper-v 以外のアプリケーションはありません。 この構成では、サーバーにインストールされるアプリケーションとサービスの数が制限されるため、コンピューターやネットワークを攻撃するために悪用される可能性のあるアプリケーションやサービスの数が減ります。 この種類の構成の効果は、攻撃対象領域の削減と呼ばれます。 安全に保護できないブランチオフィスやその他の場所では、読み取り専用ドメインコントローラー (RODC) を使用することをお勧めします。 別の管理ネットワークが存在する場合は、ホストを管理ネットワークにのみ接続することをお勧めします。
   - Bitlocker はドメインコントローラーで使用できます。 Windows Server 2016 では、仮想 TPM 機能を使用して、システムボリュームのロックを解除するためのゲストキーマテリアルを指定することもできます。
   - 保護された[ファブリックとシールド](/it-server/WindowsServerDocs/virtualization/guarded-fabric-shielded-vm/guarded-fabric-and-shielded-vms.md)された vm は、ドメインコントローラーを保護するための追加の制御を提供できます。

Rodc の詳細については、「 [読み取り専用ドメインコントローラーの計画と展開ガイド](../../deploy/rodc/read-only-domain-controller-updates.md)」を参照してください。

ドメインコントローラーのセキュリティ保護の詳細については、「 [Active Directory のインストールをセキュリティで保護するためのベストプラクティスガイド](../../plan/security-best-practices/best-practices-for-securing-active-directory.md)」を参照してください。

## <a name="security-boundaries-for-different-host-and-guest-configurations"></a>さまざまなホストおよびゲスト構成のセキュリティ境界

仮想マシンを使用すると、ドメインコントローラーのさまざまな構成を行うことができます。 仮想マシンが Active Directory トポロジ内の境界と信頼に与える影響については、慎重に検討する必要があります。 次の表では、Active Directory ドメインコントローラーとホスト (Hyper-v サーバー) とそのゲストコンピューター (hyper-v サーバーで実行されている仮想マシン) に使用できる構成について説明します。

|Machine|構成1|Configuration 2|
|-------|---------------|---------------|
|Host|ワークグループまたはメンバーコンピューター|ワークグループまたはメンバーコンピューター|
|ゲスト|ドメイン コントローラー|ワークグループまたはメンバーコンピューター|

![セキュリティ境界の図](media/virtualized-domain-controller-architecture/Dd363553.f44706fd-317e-4f0b-9578-4243f4db225f(WS.10).gif)

   - ホストコンピューターの管理者は、書き込み可能なドメインコントローラーゲスト上のドメイン管理者と同じアクセス権を持っているため、そのように扱う必要があります。 RODC ゲストの場合、ホストコンピューターの管理者は、ゲスト RODC のローカル管理者と同じアクセス権を持ちます。
   - ホストが同じドメインに参加している場合、バーチャルマシンのドメインコントローラにはホストに対する管理者権限があります。 悪意のあるユーザーが最初に仮想マシン1へのアクセス権を取得した場合、悪意のあるユーザーがすべての仮想マシンを危険にさらす可能性があります。 これは、攻撃ベクトルと呼ばれます。 複数のドメインまたはフォレストのドメインコントローラーがある場合、これらのドメインは、1つのドメインの管理者がすべてのドメインで信頼されている集中管理を行う必要があります。
   - 仮想マシン1が RODC としてインストールされている場合でも、仮想マシン1から攻撃を受ける機会が存在します。 RODC の管理者にはドメイン管理者権限が明示的に付与されていませんが、RODC を使用して、ホストコンピューターにポリシーを送信できます。 これらのポリシーには、スタートアップスクリプトが含まれる場合があります。 この操作が成功すると、ホストコンピューターが侵害され、ホストコンピューター上の他の仮想マシンを侵害するために使用できるようになります。

## <a name="security-of-vhd-files"></a>VHD ファイルのセキュリティ

仮想ドメインコントローラーの VHD ファイルは、物理ドメインコントローラーの物理ハードドライブに相当します。 そのため、物理ドメインコントローラーのハードドライブをセキュリティで保護するのと同じ程度の注意を払って保護する必要があります。 信頼できる管理者だけがドメインコントローラーの VHD ファイルへのアクセスを許可されていることを確認してください。

## <a name="rodcs"></a>Rodc

Rodc の利点の1つは、ブランチオフィスなどの物理的なセキュリティを保証できない場所に配置できることです。 Windows BitLocker ドライブ暗号化を使用すると、物理ディスクの盗難によって、ホスト上の VHD ファイル自体 (ファイルシステムではなく) を保護することができます。

## <a name="performance"></a>パフォーマンス

新しいマイクロカーネル64ビットアーキテクチャでは、以前の仮想化プラットフォームからの Hyper-v のパフォーマンスが大幅に向上しています。 最適なホストパフォーマンスを得るには、ホストが Windows Server 2008 以降の Server Core インストールであること、および Hyper-v 以外のサーバーの役割がインストールされていないことが必要です。

仮想マシンのパフォーマンスは、特にワークロードに依存します。 Active Directory のパフォーマンスを保証するには、特定のトポロジをテストします。 信頼性とパフォーマンスモニター (Perfmon.exe)、 [Microsoft アセスメント & プランニング (MAP) ツールキット](https://go.microsoft.com/fwlink/?linkid=137077)などのツールを使用して、一定期間にわたって現在のワークロードを評価します。 マップツールは、現在ネットワークに存在するすべてのサーバーとサーバーロールのインベントリを取得する場合にも役立ちます。

仮想化ドメインコントローラーのパフォーマンスに関する一般的な考え方を理解するために、次のパフォーマンステストは、 [Active Directory パフォーマンステストツール (ADTest.exe)](https://go.microsoft.com/fwlink/?linkid=137088)を使用して実行されました。

ライトウェイトディレクトリアクセスプロトコル (LDAP) テストは、物理ドメインコントローラー上で ADTest.exe と、物理ドメインコントローラーと同一のサーバーでホストされていた仮想マシン上で実行されました。 物理コンピューターに使用された論理プロセッサは1つだけで、仮想マシンが100% の CPU 使用率に簡単に対応するために使用された仮想プロセッサは1つだけです。 次の表では、各テストの後のかっこ内の文字と数字が ADTest.exe の特定のテストを示しています。 このデータが示すように、仮想化ドメインコントローラーのパフォーマンスは、物理ドメインコントローラーのパフォーマンスの 88 ~ 98% でした。

<table>
<colgroup>
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr class="header">
<th>Measurement</th>
<th>テスト</th>
<th>物理</th>
<th>仮想</th>
<th>差分</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>1秒あたりの検索数</p></td>
<td><p>基本スコープ (L1) で共通名を検索する</p></td>
<td><p>11508</p></td>
<td><p>10276</p></td>
<td><p>-10.71%</p></td>
</tr>
<tr class="even">
<td><p>1秒あたりの検索数</p></td>
<td><p>ベーススコープ (L2) で一連の属性を検索する</p></td>
<td><p>10123</p></td>
<td><p>9005</p></td>
<td><p>-11.04%</p></td>
</tr>
<tr class="odd">
<td><p>1秒あたりの検索数</p></td>
<td><p>ベーススコープ (L3) のすべての属性を検索する</p></td>
<td><p>1284</p></td>
<td><p>1242</p></td>
<td><p>-3.27%</p></td>
</tr>
<tr class="even">
<td><p>1秒あたりの検索数</p></td>
<td><p>サブツリースコープ (L6) で共通名を検索します</p></td>
<td><p>8613</p></td>
<td><p>7904</p></td>
<td><p>-8.23%</p></td>
</tr>
<tr class="odd">
<td><p>成功したバインド数/秒</p></td>
<td><p>高速バインドを実行する (B1)</p></td>
<td><p>1438</p></td>
<td><p>1374</p></td>
<td><p>-4.45%</p></td>
</tr>
<tr class="even">
<td><p>成功したバインド数/秒</p></td>
<td><p>単純なバインドを実行する (B2)</p></td>
<td><p>611</p></td>
<td><p>550</p></td>
<td><p>-9.98%</p></td>
</tr>
<tr class="odd">
<td><p>成功したバインド数/秒</p></td>
<td><p>NTLM を使用してバインドを実行する (B5)</p></td>
<td><p>1068</p></td>
<td><p>1056</p></td>
<td><p>-1.12%</p></td>
</tr>
<tr class="even">
<td><p>Writes/sec</p></td>
<td><p>複数の属性の書き込み (W2)</p></td>
<td><p>6467</p></td>
<td><p>5885</p></td>
<td><p>-9.00%</p></td>
</tr>
</tbody>
</table>

パフォーマンスを十分に確保するために、統合コンポーネント (IC) がインストールされ、ゲストオペレーティングシステムが "enlightenments"、またはハイパーバイザー対応の統合ドライバーを使用できるようになりました。 インストールプロセス中に、エミュレートされた統合ドライブエレクトロニクス (IDE) ドライバーまたはネットワークアダプタードライバーを使用する必要がある場合があります。 運用環境では、これらのエミュレートされたドライバーを合成ドライバーで置き換えて、パフォーマンスを向上させる必要があります。

信頼性とパフォーマンスマネージャー (Perfmon.exe) を使用して仮想マシンのパフォーマンスを監視する場合、仮想マシン内では、物理プロセッサ上で仮想 CPU がスケジュールされているため、CPU 情報が完全に正確ではありません。 Hyper-v サーバーで実行されている仮想マシンの CPU 情報を取得する場合は、ホストパーティション内の Hyper-v ハイパーバイザー論理プロセッサカウンターを使用します。

AD DS と Hyper-v の両方のパフォーマンスチューニングの詳細については、「 [Windows Server 2016 のパフォーマンスチューニングガイドライン](../../../../administration/performance-tuning/index.md)」を参照してください。

また、差分ディスク VHD のパフォーマンスが低下する可能性があるため、ドメインコントローラーとして構成されている仮想マシンでは、差分ディスク VHD を使用しないように計画してください。 差分ディスクを含む、Hyper-v のディスクの種類の詳細については、「 [仮想ハードディスクの新規作成ウィザード](https://go.microsoft.com/fwlink/?linkid=137279)」を参照してください。

仮想ホスティング環境での AD DS の詳細については、Microsoft サポート技術情報の「 [仮想ホスティング環境で Active Directory ドメインコントローラーをホストする場合の考慮事項](https://go.microsoft.com/fwlink/?linkid=141292) 」を参照してください。

## <a name="deployment-considerations-for-virtualized-domain-controllers"></a>仮想化ドメインコントローラーの展開に関する考慮事項

ドメインコントローラーを展開するときに回避する必要がある一般的な仮想マシンの方法と、時間の同期と記憶域に関する特別な考慮事項があります。

## <a name="virtualization-deployment-practices-to-avoid"></a>回避する仮想化の展開方法

Hyper-v などの仮想化プラットフォームには、コンピューターの管理、保守、バックアップ、および移行を容易にする便利な機能が多数用意されています。 ただし、仮想ドメインコントローラーには、次の一般的な展開方法と機能を使用しないでください。

- Active Directory 書き込みの持続性を確保するには、仮想ドメインコントローラーのデータベースファイル (Active Directory データベース (NTDS) を展開しないでください。(DIT)、ログ、SYSVOL) を仮想 IDE ディスク上に設置します。 代わりに、仮想 SCSI コントローラーに接続されている2つ目の VHD を作成し、ドメインコントローラーのインストール時に、データベース、ログ、SYSVOL が仮想マシンの SCSI ディスクに配置されていることを確認します。
- ドメインコントローラーとして構成している仮想マシンには、差分ディスクの仮想ハードディスク (Vhd) を実装しないでください。 これにより、以前のバージョンに戻すのが簡単になり、パフォーマンスも低下します。 VHD の種類の詳細については、「 [仮想ハードディスクの新規作成ウィザード](https://go.microsoft.com/fwlink/?linkid=137279)」を参照してください。
- 新しい Active Directory ドメインおよびフォレストは、システム準備ツール (Sysprep) を使用して最初に準備されていない Windows Server オペレーティングシステムのコピーには展開しないでください。 Sysprep の実行の詳細については、「 [sysprep (システムの準備) の概要](/windows-hardware/manufacture/desktop/sysprep--system-preparation--overview)」を参照してください。

   > [!WARNING]
   > ドメインコントローラーで Sysprep を実行することはサポートされていません。

- Update Sequence Number (USN) ロールバックの可能性を回避するために、既に展開されているドメインコントローラーを表す VHD ファイルのコピーを使用して、追加のドメインコントローラーを展開しないでください。 USN ロールバックの詳細については、[USN および USN ロールバックに関するページ](#usn-and-usn-rollback)をご覧ください。
   - Windows Server 2012 以降では、管理者は、追加のドメインコントローラーを展開するときに適切に準備した場合、ドメインコントローラーイメージを複製することができます。
- Hyper-v のエクスポート機能を使用して、ドメインコントローラーを実行している仮想マシンをエクスポートしないでください。
  - Windows Server 2012 以降では、ドメインコントローラーの仮想ゲストのエクスポートとインポートは、非 authoritative restore と同様に処理されます。これは、生成 ID の変更を検出し、複製用に構成されていないためです。
  - エクスポートしたゲストが使用されていないことを確認します。
    - Hyper-v レプリケーションを使用して、ドメインコントローラーの2つ目の非アクティブなコピーを保持することができます。 レプリケートされたイメージを開始する場合は、DC ゲストイメージをエクスポートした後にソースを使用しないのと同じ理由で、適切なクリーンアップを実行する必要もあります。

## <a name="physical-to-virtual-migration"></a>物理-バーチャル移行

System Center Virtual Machine Manager (VMM) 2008 では、物理マシンと仮想マシンの統合管理が提供されます。 また、物理マシンをバーチャルマシンに移行する機能も用意されています。 このプロセスは、物理-バーチャルマシン変換 (P2V 変換) と呼ばれます。 P2V [および Usn ロールバック](#usn-and-usn-rollback)に関するページで説明されているように、usn ロールバックの状況を回避するために、P2V 変換プロセス中に、移行する新しい仮想マシンと物理ドメインコントローラーが同時に実行されていない必要があります。

ドメインコントローラーが再度有効になったときにディレクトリデータの整合性を保つために、オフラインモードを使用して P2V 変換を実行する必要があります。 [オフラインモード] オプションが用意されており、物理サーバー変換ウィザードで推奨されています。 オンラインモードとオフラインモードの違いの詳細については、「 [P2V: VMM での物理コンピューターから Virtual Machines への変換](https://go.microsoft.com/fwlink/?linkid=155072)」を参照してください。 P2V 変換中に、仮想マシンをネットワークに接続することはできません。 バーチャルマシンのネットワークアダプターは、P2V 変換プロセスが完了し、検証された後にのみ有効にする必要があります。 この時点で、物理ソースマシンはオフになります。 ハードディスクを再フォーマットする前に、物理ソースマシンをネットワーク上に戻さないでください。

> [!NOTE]
> 新しい仮想 Dc を作成する場合は、USN ロールバックを作成するリスクがないため、より安全なオプションがあります。 新しい仮想 DC は、通常の昇格、メディアからのインストール (IfM) からの昇格、およびドメインコントローラーの複製 (既に少なくとも1つの仮想 DC がある場合) を使用してセットアップすることができます。
これは、ハードウェアまたはプラットフォームに関連する問題の回避にも役立ちます。 P2V 変換された仮想ゲストが遭遇する可能性があります。

> [!WARNING]
> Active Directory レプリケーションに関する問題を回避するには、特定のドメインコントローラのインスタンス (物理または仮想) が特定の時点で1つのネットワークに存在していることを確認します。
> 古い複製が問題になる可能性を低くすることができます。
>
> - 新しい仮想 DC が実行されているときに、次のようにしてコンピューターアカウントのパスワードを2回変更します。 netdom resetpwd/Server: <ドメインコントローラー>...
> - 新しい仮想ゲストをエクスポートしてインポートし、強制的に新しい世代 ID にして、データベースの起動 ID にします。

## <a name="using-p2v-migration-to-create-test-environments"></a>P2V 移行を使用してテスト環境を作成する

VMM を介した P2V 移行を使用して、テスト環境を作成できます。 運用環境のドメインコントローラーを物理マシンから仮想マシンに移行して、実稼働ドメインコントローラーを完全にダウンさせずに、テスト環境を作成することができます。 ただし、同じドメインコントローラーの2つのインスタンスが存在する場合は、テスト環境を運用環境とは別のネットワークに配置する必要があります。 テスト環境や運用環境に影響を与える USN ロールバックを避けるために、P2V 移行を使用してテスト環境を作成することをお勧めします。 P2V を使用してテスト環境を作成するために使用できる方法を次に示します。

各ドメインの1つの実稼働ドメインコントローラーは、「物理-仮想移行」セクションで説明されているガイドラインに従って、P2V を使用してテスト仮想マシンに移行されます。 物理的な運用コンピューターとテスト用の仮想マシンは、オンラインに戻ったときに別のネットワークに配置する必要があります。 テスト環境で USN ロールバックが行われないようにするには、物理マシンから仮想マシンに移行するすべてのドメインコントローラーをオフラインにする必要があります。 (これを行うには、ntds サービスを停止するか、ディレクトリサービス復元モード (DSRM) でコンピューターを再起動します)。ドメインコントローラーがオフラインになった後は、新しい更新プログラムを環境に導入する必要はありません。 P2V 移行中は、コンピューターをオフラインのままにしておく必要があります。すべてのコンピューターが完全に移行されるまで、どのコンピューターもオンラインに戻す必要はありません。 USN ロールバックの詳細については、USN および USN ロールバックに関するページを参照してください。

後続のテストドメインコントローラーは、テスト環境でレプリカとして昇格される必要があります。

## <a name="time-service"></a>Time サービス

ドメインコントローラーとして構成されている仮想マシンの場合、ドメインコントローラーとして動作するホストシステムとゲストオペレーティングシステム間の時間の同期を無効にすることをお勧めします。 これにより、ゲストドメインコントローラーはドメイン階層から時刻を同期させることができます。

Hyper-v タイム同期プロバイダーを無効にするには、VM をシャットダウンし、[Integration Services] の [時間の同期] チェックボックスをオフにします。

> [!NOTE]
> このガイダンスは最近更新され、ドメイン階層のみからゲストドメインコントローラーの時刻を同期するための現在の推奨事項を反映するようになりました。これは、前の推奨事項ではなく、ホストシステムとゲストドメインコントローラー間の時間の同期を部分的に無効にすることです。

## <a name="storage"></a>ストレージ

ドメインコントローラーの仮想マシンのパフォーマンスを最適化し、Active Directory 書き込みの持続性を確保するには、オペレーティングシステム、Active Directory、および VHD ファイルの格納に次の推奨事項を使用します。

- **ゲストストレージ** 。 Active Directory データベースファイル (ntds.dit)、ログファイル、SYSVOL ファイルを、オペレーティングシステムファイルとは別の仮想ディスクに保存します。 仮想 SCSI コントローラーに接続されている2つ目の VHD を作成し、その仮想マシンの仮想 SCSI ディスクにデータベース、ログ、および SYSVOL を格納します。 仮想 SCSI ディスクを使用すると、仮想 IDE と比較してパフォーマンスが向上し、強制ユニットアクセス (FUTEX) がサポートされます。 これにより、オペレーティングシステムは、すべてのキャッシュメカニズムをバイパスして、メディアから直接データを書き込み、読み取ります。

  > [!NOTE]
  > 仮想 DC ゲストに Bitlocker を使用する予定がある場合は、追加のボリュームが "自動ロック解除" 用に構成されていることを確認する必要があります。
  > 自動ロック解除の構成の詳細については[、BitLockerAutoUnlock](/powershell/module/bitlocker/enable-bitlockerautounlock)を参照してください。

- **VHD ファイルのホスト記憶域** 。 推奨事項: ホスト記憶域の推奨事項は、VHD ファイルの記憶域です。 最大のパフォーマンスを実現するには、ホストの Windows オペレーティングシステムがインストールされているシステムディスクなど、他のサービスやアプリケーションによって頻繁に使用されるディスクに VHD ファイルを格納しないでください。 各 VHD ファイルは、ホストオペレーティングシステムおよびその他のすべての VHD ファイルとは別のパーティションに格納します。 最適な構成は、各 VHD ファイルを別々の物理ドライブに格納することです。

  また、仮想化されたワークロードデータの整合性の要件を満たすには、ホストの物理ディスクシステムが次の条件の少なくとも **1 つ** を満たしている必要があります。

   - システムは、サーバークラスのディスク (SCSI、ファイバーチャネル) を使用します。
   - システムによって、ディスクがバッテリ付きのキャッシュホストバスアダプター (HBA) に接続されていることを確認します。
   - システムは、記憶域コントローラー (たとえば、RAID システム) を記憶装置として使用します。
   - システムにより、ディスクの電源が無停電電源装置 (UPS) によって保護されていることを確認します。
   - システムによって、ディスクの書き込みキャッシュ機能が無効になっていることが確認されます。

- **VHD とパススルーディスクを固定** します。 仮想マシンの記憶域を構成するには、さまざまな方法があります。 VHD ファイルを使用する場合、固定サイズの vhd は動的 Vhd よりも効率的です。固定サイズの vhd のメモリは、作成時に割り当てられるためです。 物理記憶域メディアにアクセスするために仮想マシンが使用できるパススルーディスクは、パフォーマンスを向上させるためにさらに最適化されています。 パススルーディスクは、仮想マシンに接続されている物理ディスクまたは論理ユニット番号 (Lun) です。 パススルーディスクでは、スナップショット機能はサポートされていません。 そのため、ドメインコントローラーでのスナップショットの使用は推奨されないため、パススルーディスクは推奨されるハードディスク構成です。

Active Directory データが破損する可能性を低減するには、仮想 SCSI コントローラーを使用します。

   - 仮想ドメインコントローラーをホストする Hyper-v サーバーでは、(IDE/ATA ドライブではなく) SCSI 物理ドライブを使用します。 SCSI ドライブを使用できない場合は、仮想ドメインコントローラーをホストする ATA/IDE ドライブで書き込みキャッシュが無効になっていることを確認してください。 詳細については、「 [イベント ID 1539 –データベースの整合性](https://go.microsoft.com/fwlink/?linkid=162419)」を参照してください。
   - Active Directory の書き込みの持続性を保証するには、Active Directory データベース、ログ、SYSVOL を仮想 SCSI ディスクに配置する必要があります。 バーチャル SCSI ディスクでは、強制ユニットアクセス (FUTEX) がサポートされます。 これにより、オペレーティングシステムは、すべてのキャッシュメカニズムをバイパスして、メディアから直接データを書き込み、読み取ります。

## <a name="operational-considerations-for-virtualized-domain-controllers"></a>仮想化ドメインコントローラーの操作に関する考慮事項

仮想マシンで実行されているドメインコントローラーには、物理コンピューター上で実行されているドメインコントローラーには適用されない操作上の制限があります。 仮想化ドメインコントローラーを使用する場合、使用すべきではない仮想化ソフトウェアの機能と運用方法がいくつかあります。

   - 仮想マシンでのドメインコントローラーの保存された状態は、フォレストの廃棄 (tombstone) の有効期間より長い時間にわたって一時停止、停止、または保存しないでください。その後、一時停止または保存された状態から再開します。 これにより、レプリケーションが妨げられる可能性があります。 フォレストの廃棄 (tombstone) の有効期間を確認する方法については、 [フォレストの廃棄 (tombstone) の有効期間の決定に関する](https://go.microsoft.com/fwlink/?linkid=137177)ページを参照してください。
   - バーチャルハードディスク (Vhd) をコピーまたは複製しないでください。 ゲスト VM のセーフガードを使用していても、個々の Vhd をコピーして、USN ロールバックを発生させることができます。
   - 仮想ドメインコントローラーのスナップショットを取得したり、使用したりしないでください。 これは、Windows Server 2012 以降では技術的にはサポートされていますが、適切なバックアップ戦略に代わるものではありません。 DC スナップショットを取得したり、スナップショットを復元したりする理由はいくつかあります。
   - ドメインコントローラーとして構成されている仮想マシンでは、差分ディスク VHD を使用しないでください。 これにより、以前のバージョンに簡単に戻すことができ、パフォーマンスが低下します。
   - ドメインコントローラーを実行している仮想マシンでは、エクスポート機能を使用しないでください。
   - サポートされているバックアップを使用する以外の方法で、ドメインコントローラーを復元したり、Active Directory データベースの内容をロールバックしたりしないでください。 詳細については、「 [仮想化ドメインコントローラーのバックアップと復元に関する考慮事項](#backup-and-restore-practices-to-avoid)」を参照してください。

これらのすべての推奨事項は、Update Sequence Number (USN) ロールバックの可能性を回避するために作成されます。 USN ロールバックの詳細については、USN および USN ロールバックに関するページをご覧ください。

## <a name="backup-and-restore-considerations-for-virtualized-domain-controllers"></a>仮想化ドメインコントローラーのバックアップと復元に関する考慮事項

ドメインコントローラーのバックアップは、どの環境においても重要な要件です。 バックアップでは、ドメインコントローラーの障害または管理エラーが発生した場合にデータの損失を防ぐことができます。 このようなイベントが発生した場合は、ドメインコントローラーのシステム状態を、障害またはエラーが発生する前の時点にロールバックする必要があります。 ドメインコントローラーを正常な状態に復元するには、Windows Server バックアップなどの Active Directory 互換のバックアップアプリケーションを使用して、ドメインコントローラーの現在のインストールからのシステム状態のバックアップを復元します。 Active Directory Domain Services (AD DS) での Windows Server バックアップの使用の詳細については、 [AD DS バックアップと回復の手順ガイド](https://go.microsoft.com/fwlink/?LinkId=138501)を参照してください。

仮想マシンテクノロジでは、Active Directory の復元操作の特定の要件によって、追加の重要度が考慮されます。 たとえば、仮想ハードディスク (VHD) ファイルのコピーを使用してドメインコントローラーを復元する場合は、ドメインコントローラーを復元した後に、そのドメインコントローラーのデータベースバージョンを更新するための重要な手順を省略します。 レプリケーションは不適切な追跡番号で続行されるため、ドメインコントローラーレプリカ間でデータベースの一貫性が損なわれます。 ほとんどの場合、この問題はレプリケーションシステムによって検出されず、ドメインコントローラー間で不整合が発生してもエラーは報告されません。

仮想化ドメインコントローラーのバックアップと復元を実行するには、次の1つの方法がサポートされています。

1. ゲストオペレーティングシステムで Windows Server バックアップを実行します。

Windows Server 2012 およびそれ以降の Hyper-v ホストとゲストでは、スナップショット、ゲスト VM のエクスポートとインポート、および Hyper-v レプリケーションを使用して、ドメインコントローラーのサポートされているバックアップを実行できます。 ただし、これらはすべて、適切なバックアップ履歴を作成するのに適しているわけではありませんが、ゲスト VM のエクスポートはわずかな例外です。

Windows Server 2016 Hyper-v では、Hyper-v サーバーによってゲストの VSS ベースのバックアップがトリガーされる "運用スナップショット" がサポートされており、ゲストがスナップショットを使用して実行されると、ホストが Vhd をフェッチし、バックアップの場所に格納します。

これは Windows Server 2012 以降で動作しますが、Bitlocker との互換性がありません。

- VSS スナップショットを実行する場合、AD はスナップショット後のタスクを実行して、バックアップからのデータとしてマークします。または、RODC の IFM ソースを準備する場合は、データベースから資格情報を削除します。
- Hyper-v がこのタスクのためにスナップショットボリュームをマウントする場合、暗号化されていないアクセスのためにボリュームのロックを解除する機能はありません。 そのため、AD データベースエンジンはデータベースへのアクセスに失敗し、最終的にスナップショットに失敗します。

> [!NOTE]
> 前に説明したシールドされた VM プロジェクトには、ゲスト VM の最大データ保護に対する非目標として Hyper-v ホスト主導のバックアップがあります。

## <a name="backup-and-restore-practices-to-avoid"></a>回避するためのバックアップと復元の方法

前述のように、仮想マシンで実行されているドメインコントローラーには、物理コンピューターで実行されているドメインコントローラーには適用されない制限があります。 仮想ドメインコントローラーをバックアップまたは復元する際には、次のような特定の仮想化ソフトウェアの機能と運用方法を使用しないことをお勧めします。

   - 通常のバックアップを実行するのではなく、ドメインコントローラーの VHD ファイルをコピーまたは複製しないでください。 VHD ファイルがコピーまたは複製された場合は、古いものになります。 その後、VHD が通常モードで起動すると、USN ロールバックが発生します。 Windows Server バックアップ機能を使用するなど、Active Directory Domain Services (AD DS) でサポートされている適切なバックアップ操作を実行する必要があります。
   - バックアップとしてスナップショット機能を使用して、ドメインコントローラーとして構成された仮想マシンを復元しないでください。 Windows Server 2008 R2 以前のバージョンで仮想マシンを以前の状態に戻すと、レプリケーションで問題が発生します。 詳細については、[USN および USN ロールバックに関するページ](#usn-and-usn-rollback)をご覧ください。 読み取り専用ドメインコントローラー (RODC) の復元にスナップショットを使用しても、レプリケーションの問題は発生しませんが、この復元方法はお勧めできません。

## <a name="restoring-a-virtual-domain-controller"></a>仮想ドメインコントローラーを復元する

ドメインコントローラーに障害が発生したときに復元するには、システム状態を定期的にバックアップする必要があります。 システム状態には、Active Directory のデータとログファイル、レジストリ、システムボリューム (SYSVOL フォルダー)、およびオペレーティングシステムのさまざまな要素が含まれます。 この要件は、物理および仮想ドメインコントローラーでも同じです。 Active Directory と互換性のあるバックアップアプリケーションが実行するシステム状態の復元手順は、復元処理後にローカルデータベースとレプリケートされる Active Directory データベースの整合性を確保するように設計されています。これには、起動 ID がリセットされたレプリケーションパートナーへの通知も含まれます。 ただし、仮想ホスティング環境とディスクまたはオペレーティングシステムのイメージングアプリケーションを使用すると、ドメインコントローラーのシステム状態が復元されるときに通常発生するチェックと検証を管理者が回避できます。

ドメインコントローラーの仮想マシンで障害が発生し、Update Sequence Number (USN) のロールバックが行われていない場合、仮想マシンの復元には次の2つの状況がサポートされます。

   - 障害が登場ている有効なシステム状態データバックアップが存在する場合は、バックアップの作成に使用したバックアップユーティリティの復元オプションを使用してシステム状態を復元できます。 システム状態データのバックアップは、廃棄 (tombstone) の有効期間内で Active Directory 互換のバックアップユーティリティを使用して作成されている必要があります。これは、既定では180日以内です。 少なくとも半廃棄 (tombstone) の有効期間でドメインコントローラーをバックアップする必要があります。 フォレストの特定の廃棄 (tombstone) の有効期間を決定する手順については、「 [フォレストの廃棄 (tombstone) の有効期間を決定](https://go.microsoft.com/fwlink/?linkid=137177)する」を参照してください。
   - VHD ファイルの作業コピーが使用可能であっても、システム状態のバックアップがない場合は、既存の仮想マシンを削除できます。 以前の VHD のコピーを使用して既存の仮想マシンを復元しますが、次のセクションで説明するように、VHD をディレクトリサービス復元モード (DSRM) で起動し、レジストリを適切に構成してください。 次に、通常モードでドメインコントローラーを再起動します。

次の図に示すプロセスを使用して、仮想化ドメインコントローラーを復元するための最適な方法を決定します。

![図: 仮想化ドメインコントローラーを復元する方法](media/virtualized-domain-controller-architecture/Dd363553.85c97481-7b95-4705-92a7-006e48bc29d0(WS.10).gif)

Rodc の場合、復元プロセスと決定は簡単です。

![図読み取り専用ドメインコントローラーを復元する方法](media/virtualized-domain-controller-architecture/Dd363553.4c5c5eda-df95-4c6b-84e0-d84661434e5d(WS.10).gif)

## <a name="restoring-the-system-state-backup-of-a-virtual-domain-controller"></a>仮想ドメインコントローラーのシステム状態のバックアップを復元しています

ドメインコントローラーの仮想マシンに有効なシステム状態のバックアップが存在する場合は、VHD ファイルのバックアップに使用したバックアップツールで規定されている復元手順に従って、バックアップを安全に復元できます。

> [!IMPORTANT]
> ドメインコントローラーを正しく復元するには、そのコントローラーを DSRM で起動する必要があります。 ドメインコントローラーを通常モードで起動できないようにする必要があります。 システムの起動時に DSRM を開始できない場合は、ドメインコントローラーの仮想マシンを無効にしてから、通常モードで完全に起動します。 ドメインコントローラーがネットワークから切断されている場合でも、通常モードでドメインコントローラーを起動すると Usn が増加するため、ドメインコントローラーを DSRM で起動することが重要です。 USN ロールバックの詳細については、USN および USN ロールバックに関するページをご覧ください。

## <a name="to-restore-the-system-state-backup-of-a-virtual-domain-controller"></a>仮想ドメインコントローラーのシステム状態のバックアップを復元するには

1. ドメインコントローラーの仮想マシンを起動し、F5 キーを押して Windows ブートマネージャーの画面にアクセスします。 接続の資格情報を入力する必要がある場合は、仮想マシンの [ **一時停止** ] ボタンをすぐにクリックして、起動を続行しないようにします。 次に、接続の資格情報を入力し、仮想マシンの [ **再生** ] ボタンをクリックします。 仮想マシンウィンドウ内をクリックし、F5 キーを押します。

   Windows ブートマネージャーの画面が表示されず、ドメインコントローラーが通常モードで起動を開始している場合は、仮想マシンをオフにして起動を完了しないようにします。 Windows ブートマネージャー画面にアクセスできるようになるまで、必要な回数だけこの手順を繰り返します。 Windows エラー回復メニューから DSRM にアクセスすることはできません。 そのため、Windows エラー回復メニューが表示された場合は、仮想マシンをオフにして、もう一度実行してください。

2. Windows ブートマネージャー画面で、F8 キーを押して、高度なブートオプションにアクセスします。
3. [ **詳細ブートオプション** ] 画面で、[ **ディレクトリサービス復元モード** ] を選択し、enter キーを押します。 これにより、ドメインコントローラーが DSRM で起動します。
4. システム状態のバックアップを作成するために使用したツールに適切な復元方法を使用します。 Windows Server バックアップを使用した場合は、「 [AD DS の権限のない復元を実行](https://go.microsoft.com/fwlink/?linkid=132637)する」を参照してください。

## <a name="restoring-a-virtual-domain-controller-when-an-appropriate-system-state-data-backup-is-not-available"></a>適切なシステム状態データバックアップが使用できない場合に仮想ドメインコントローラーを復元する

バーチャルマシンの障害を登場システム状態データのバックアップがない場合は、以前の VHD ファイルを使用して、バーチャルマシン上で実行されているドメインコントローラを復元できます。 可能な場合は、VHD のコピーを作成します。これにより、手順の実行中に問題が発生した場合や、手順を見逃した場合に、コピーした VHD でもう一度試すことができます。

> [!IMPORTANT]
> - 定期的に計画およびスケジュールされたバックアップの代わりに、次の手順を使用することは検討しないようにしてください。
> - **次の手順で実行される復元は、Microsoft ではサポートされていません。別の方法がない場合にのみ使用してください。**
> - 復元しようとしている VHD のコピーが仮想マシンによって通常モードで開始されている場合は、この手順を使用しないでください。

## <a name="to-restore-a-previous-version-of-a-virtual-domain-controller-vhd-without-system-state-data-backup"></a>システム状態データのバックアップを使用せずに以前のバージョンの仮想ドメインコントローラー VHD を復元するには

1. 前のセクションで説明したように、前の VHD を使用して、DSRM で仮想ドメインコントローラーを起動します。 ドメインコントローラーを通常モードで起動できないようにします。 Windows ブートマネージャーの画面が表示されず、ドメインコントローラーが通常モードで起動を開始した場合は、仮想マシンをオフにして起動を完了できないようにします。 DSRM を開始するための詳細な手順については、前のセクションを参照してください。
2. レジストリ エディターを開きます。 レジストリエディターを開くには、[ **スタート** ]、[ **実行** ] の順にクリックし、「 **regedit** 」と入力して、[OK] をクリックします。 [ **ユーザー アカウント制御** ] ダイアログ ボックスが表示されたら、表示された操作が正しいことを確認し、[ **はい** ] をクリックします。 レジストリエディターで、次のパスを展開します。 **HKEY \_ LOCAL \_ MACHINE \\ SYSTEM \\ CurrentControlSet \\ Services \\ NTDS \\ Parameters** . 「 **DSA Previous Restore Count** 」という名前の値を探します。 値がある場合は、設定をメモしておきます。 値が指定されていない場合、設定は既定値 (ゼロ) と等しくなります。 値が表示されない場合は、追加しないでください。
3. **Parameters** キーを右クリックし、[ **新規** ] をクリックして、[ **DWORD (32 ビット) 値** ] をクリックします。
4. **バックアップから復元** された新しい名前データベースを入力し、enter キーを押します。
5. 先ほど作成した値をダブルクリックして [ **DWORD (32 ビット) 値の編集** ] ダイアログボックスを開き、[ **値のデータ** ] ボックスに「 **1** 」と入力します。 **バックアップエントリから復元** されたデータベースは、Windows 2000 Server Service Pack 4 (SP4) を実行しているドメインコントローラーで使用できます。また、windows server 2003 では、windows [Server 2003、windows server 2008、Windows server 2008 R2 の USN ロールバックの検出方法と回復方法につい](https://go.microsoft.com/fwlink/?linkid=137182)ても説明しています。
6. 通常モードでドメインコントローラーを再起動します。
7. ドメインコントローラーが再起動したら、イベントビューアーを開きます。 イベント ビューアーを開くには、[ **スタート** ] ボタンをクリックし、[ **コントロール パネル** ] をクリックします。次に、[ **管理ツール** ] をダブルクリックし、[ **イベント ビューアー** ] をダブルクリックします。
8. [ **アプリケーションとサービスログ** ] を展開し、[ **ディレクトリサービス** ログ] をクリックします。 [詳細] ウィンドウにイベントが表示されていることを確認します。
9. **ディレクトリサービス** ログを右クリックし、[ **検索** ] をクリックします。 [ **検索する文字列** ] に「 **1109** 」と入力し、[ **次を検索** ] をクリックします。
10. 少なくともイベント ID 1109 のエントリが表示できます。 このエントリが表示されない場合は、次の手順に進みます。 それ以外の場合は、エントリをダブルクリックし、InvocationID に対して更新されたことを確認するテキストを確認します。

    ```
    Active Directory has been restored from backup media, or has been configured to host an application partition.
    The invocationID attribute for this directory server has been changed.
    The highest update sequence number at the time the backup was created is <time>

    InvocationID attribute (old value):<Previous InvocationID value>
    InvocationID attribute (new value):<New InvocationID value>
    Update sequence number:<USN>

    The InvocationID is changed when a directory server is restored from backup media or is configured to host a writeable application directory partition.
    ```

11. イベント ビューアーを閉じます。
12. レジストリエディターを使用して、 **DSA Previous Restore Count** の値が前の値に1を足した値に等しいことを確認します。 これが正しい値ではなく、イベントビューアーでイベント ID 1109 のエントリが見つからない場合は、ドメインコントローラーのサービスパックが最新であることを確認します。 同じ VHD でこの手順を再度実行することはできません。 手順 1. から開始して、通常モードで起動していない VHD または別の VHD のコピーに対して、もう一度やり直すことができます。
13. レジストリ エディタを閉じます。

## <a name="usn-and-usn-rollback"></a>USN および USN ロールバック

このセクションでは、古いバージョンの仮想マシンで Active Directory データベースを復元した結果として発生する可能性があるレプリケーションの問題について説明します。 Active Directory レプリケーションプロセスの詳細については、「 [Active Directory レプリケーションの概念](../replication/active-directory-replication-concepts.md)」を参照してください。

## <a name="usns"></a>Usn

Active Directory Domain Services (AD DS) は、更新シーケンス番号 (Usn) を使用して、ドメインコントローラー間でのデータのレプリケーションを追跡します。 ディレクトリ内のデータに変更が加えられるたびに、変更が加えられたことを示すために USN がインクリメントされます。

宛先ドメインコントローラーによって格納されている各ディレクトリパーティションについて、Usn は、ドメインコントローラーによってデータベースに導入された最新の更新プログラムを追跡するため、およびディレクトリパーティションのレプリカを格納する他のすべてのドメインコントローラーの状態を追跡するために使用されます。 ドメインコントローラは、変更を相互にレプリケートするときに、レプリケーションパートナーに対して、各パートナーからドメインコントローラが最後に受信した変更の USN を超える usn を持つ変更を照会します。

次の2つのレプリケーションメタデータテーブルには、Usn が含まれています。 移行元と移行先のドメインコントローラーは、接続先のドメインコントローラーが必要とする更新プログラムをフィルター処理するために使用します。

1. **最新のベクター** : すべてのソースドメインコントローラーから受信した元の更新を追跡するために、宛先ドメインコントローラーによって保持されるテーブル。 宛先ドメインコントローラは、ディレクトリパーティションの変更を要求すると、ソースドメインコントローラに最新のベクターを提供します。 ソースドメインコントローラーは、この値を使用して、送信先ドメインコントローラーに送信される更新プログラムをフィルター処理します。 ソースドメインコントローラーは、正常なレプリケーションサイクルの完了時に、最新のベクターを送信先に送信します。これにより、移行先ドメインコントローラーは、すべてのドメインコントローラーが元の更新と同期していることを認識し、更新プログラムはソースと同じレベルにあることを確認します。
2. **High watermark** : 宛先ドメインコントローラーが、特定のパーティションの特定のソースドメインコントローラーから受信した最新の変更を追跡するために保持する値。 ハイウォーターマークは、移行先ドメインコントローラーによって既に受信された変更が、ソースドメインコントローラーによって送信されないようにします。

## <a name="directory-database-identity"></a>ディレクトリデータベース id

Usn に加えて、ドメインコントローラーは、ソースレプリケーションパートナーのディレクトリデータベースを追跡します。 サーバーで実行されているディレクトリデータベースの id は、サーバーオブジェクト自体の id とは別に保持されます。 各ドメインコントローラーのディレクトリデータベース id は、NTDS 設定オブジェクトの **invocationID** 属性に格納されます。この属性は、次のライトウェイトディレクトリアクセスプロトコル (LDAP) パスにあります。 CN = ntds 設定、Cn = ServerName、Cn = Servers、Cn = *SiteName* 、cn = Sites、cn = Configuration、dc = *ForestRootDomain* 。 サーバーオブジェクト id は、NTDS 設定オブジェクトの **objectGUID** 属性に格納されます。 サーバーオブジェクトの id が変更されることはありません。 ただし、システム状態の復元手順がサーバーで発生したとき、またはアプリケーションディレクトリパーティションが追加されたときに、ディレクトリデータベースの id が変更され、サーバーから削除された後に再追加されます。 (その他のシナリオ: HyperV インスタンスによって、仮想 DC の VHD を含むパーティション上の VSS ライターがトリガーされると、ゲストはその vss ライター (上記のバックアップ/復元で使用されるものと同じメカニズム) をトリガーし、invocationID がリセットされます。

その結果、 **invocationID** は、ドメインコントローラー上の一連の更新を、ディレクトリデータベースの特定のバージョンに効果的に関連付けます。 最新のベクターと high watermark テーブルでは、 **invocationID** と DC GUID がそれぞれ使用されます。これにより、ドメインコントローラーは、レプリケーション情報が送信されている Active Directory データベースのコピーから認識できるようになります。

**InvocationID** は、コマンド **repadmin/showrepl** を実行した後に出力の先頭付近に表示されるグローバル一意識別子 (GUID) 値です。 次のテキストは、コマンドからの出力例を示しています。

   ```
   Repadmin: running command /showrepl against full DC local host
   Default-First-Site-Name\VDC1
   DSA Options: IS_GC
   DSA object GUID: 966651f3-a544-461f-9f2c-c30c91d17818
   DSA invocationID: b0d9208b-8eb6-4205-863d-d50801b325a9
   ```

AD DS がドメインコントローラー上で正しく復元されると、 **invocationID** がリセットされます。 この変更の結果として、レプリケーショントラフィックの増加が発生します。これは、レプリケートされているパーティションのサイズに対する相対的な時間です。

たとえば、VDC1 と DC2 が同じドメイン内の2つのドメインコントローラーであるとします。 次の図は、適切な復元状況で invocationID 値がリセットされた場合の、VDC1 に関する DC2 の認識を示しています。

![InvocationID 値が適切にリセットされたときのダイアグラム](media/virtualized-domain-controller-architecture/Dd363553.ca71fc12-b484-47fb-991c-5a0b7f516366(WS.10).gif)

## <a name="usn-rollback"></a>USN ロールバック

USN のロールバックは、usn の通常の更新が回避され、ドメインコントローラーが最新の更新プログラムよりも古い USN を使用しようとした場合に発生します。 USN ロールバックが検出され、ほとんどの場合、フォレスト内の分岐が作成される前にレプリケーションが停止します。

USN ロールバックは多くの原因で発生する可能性があります。たとえば、古い仮想ハードディスク (VHD) ファイルが使用されている場合や、物理-バーチャル変換 (P2V 変換) が実行された場合などです。変換後に物理マシンが完全にオフラインのままになることはありません。 USN ロールバックが行われないようにするには、次の予防措置を取ります。

   - Windows Server 2012 以降を実行していない場合は、ドメインコントローラー仮想マシンのスナップショットを取得したり使用したりしないでください。
   - ドメインコントローラーの VHD ファイルはコピーしないでください。
   - Windows Server 2012 以降を実行していない場合は、ドメインコントローラーを実行している仮想マシンをエクスポートしないでください。
   - Windows Server バックアップなど、サポートされているバックアップソリューション以外の方法で、ドメインコントローラーを復元したり、Active Directory データベースの内容をロールバックしたりしないでください。

場合によっては、USN ロールバックが検出されないことがあります。 それ以外の場合は、他のレプリケーションエラーが発生する可能性があります。 このような場合は、問題の範囲を特定し、適切なタイミングで対処する必要があります。 USN ロールバックの結果として発生する可能性のある残留オブジェクトを削除する方法の詳細については、Microsoft サポート技術情報の「 [Windows Server 2003 で古い Active Directory オブジェクトがイベント ID 1988 を生成](https://go.microsoft.com/fwlink/?linkid=137185) する」を参照してください。

## <a name="usn-rollback-detection"></a>USN ロールバックの検出

ほとんどの場合、不適切な復元手順が原因で発生した **invocationID** の対応するリセットを行わずに、USN ロールバックが検出されます。 Windows Server 2008 では、不適切なドメインコントローラーの復元操作の後に、不適切なレプリケーションに対する保護が提供されます。 これらの保護は、不適切な復元操作によって、レプリケーションパートナーが既に受信した変更の元の変更を表す Usn が減少することによってトリガーされます。

Windows Server 2008 および Windows Server 2003 SP1 では、移行先ドメインコントローラーが以前に使用した USN を使用して変更を要求した場合、ソースレプリケーションパートナーによる応答は、移行先ドメインコントローラーによって解釈され、レプリケーションメタデータが古くなっていることを意味します。 これは、ソースドメインコントローラー上の Active Directory データベースが以前の状態にロールバックされたことを示します。 たとえば、仮想マシンの VHD ファイルは、以前のバージョンにロールバックされています。 この場合、移行先ドメインコントローラーは、不適切な復元が行われたと判断されたドメインコントローラーで次の検疫対策を開始します。

   - AD DS は Net Logon サービスを一時停止します。これにより、ユーザーアカウントとコンピューターアカウントがアカウントのパスワードを変更できなくなります。 この操作により、不適切な復元後に変更が発生した場合にその変更が失われるのを防ぐことができます。
   - AD DS は、受信および送信の Active Directory レプリケーションを無効にします。
   - AD DS は、条件を示すために、ディレクトリサービスのイベントログにイベント ID 2095 を生成します。

次の図は、仮想マシンで実行されている宛先ドメインコントローラーである VDC2 で USN ロールバックが検出されたときに発生するイベントのシーケンスを示しています。 この図では、レプリケーションパートナーが、VDC2 が宛先ドメインコントローラーによって以前に検出された最新の USN 値を送信したことを検出すると、VDC2 で USN ロールバックの検出が発生します。これは、Vdc2 データベースが適切な時間内にロールバックされたことを示します。

![USN ロールバックが検出された場合の動作を示す図](media/virtualized-domain-controller-architecture/Dd363553.373b0504-43fc-40d0-9908-13fdeb7b3f14(WS.10).gif)

ディレクトリサービスのイベントログでイベント ID 2095 が報告された場合は、すぐに次の手順を実行します。

## <a name="to-resolve-event-id-2095"></a>イベント ID 2095 を解決するには

1. エラーを記録した仮想マシンをネットワークから分離します。
2. このドメインコントローラーから変更が発生し、他のドメインコントローラーに反映されたかどうかを確認します。 仮想マシンのスナップショットまたはコピーが開始された結果としてイベントが発生した場合は、USN ロールバックが発生した時間を確認してください。 その後、そのドメインコントローラーのレプリケーションパートナーを確認して、その後にレプリケーションが発生したかどうかを確認できます。

   Repadmin ツールを使用して、この判断を行うことができます。 Repadmin の使用方法の詳細については、「 [Repadmin を使用した Active Directory レプリケーションの監視とトラブルシューティング](https://go.microsoft.com/fwlink/?linkid=122830)」を参照してください。 これを自分で特定できない場合は、 [Microsoft サポート](https://support.microsoft.com) に問い合わせてください。

3. ドメインコントローラを強制的に降格します。 これには、ドメインコントローラーのメタデータをクリーンアップし、操作マスター (フレキシブルシングルマスター操作または FSMO とも呼ばれます) の役割を強制する作業が含まれます。 詳細については、Microsoft サポート技術情報の「 [Windows server 2003、Windows server 2008、および Windows server 2008 R2 で usn ロールバックを検出して回復する方法](https://go.microsoft.com/fwlink/?linkid=137182) 」の「usn ロールバックからの回復」を参照してください。
4. ドメインコントローラのすべての以前の VHD ファイルを削除します。

## <a name="undetected-usn-rollback"></a>検出のない USN ロールバック

USN ロールバックは、次の2つの状況のいずれかでは検出されない可能性があります。

1. VHD ファイルは、複数の場所で同時に実行されている別の仮想マシンに接続されています。
2. 復元されたドメインコントローラーの USN が、他のドメインコントローラーによって受信された最後の USN を超えて増加しています。

最初の状況では、他のドメインコントローラーがいずれかの仮想マシンでレプリケートされる可能性があります。また、いずれかの仮想マシンで変更が行われる可能性があります。 フォレストのこのような相違点を検出することは困難で、予期しないディレクトリの応答が発生します。 この状況は、物理マシンと仮想マシンの両方が同じネットワーク上で実行されている場合に、P2V 移行後に発生する可能性があります。 これは、複数の仮想ドメインコントローラーが同じ物理ドメインコントローラーから作成され、同じネットワーク上で実行された場合にも発生する可能性があります。

2番目の状況では、一連の Usn が2つの異なる変更セットに適用されます。 これは、検出されずに継続して延長できます。 その間に作成されたオブジェクトが変更されるたびに、残留オブジェクトが検出され、イベントビューアーでイベント ID 1988 として報告されます。 次の図は、このような状況で USN ロールバックが検出されない可能性があることを示しています。

![USN ロールバックが検出されない可能性がある図](media/virtualized-domain-controller-architecture/Dd363553.63565fe0-d970-4b4e-b5f3-9c76bc77e2d4(WS.10).gif)

## <a name="read-only-domain-controllers"></a>読み取り専用ドメイン コントローラー

Rodc は、Active Directory データベース内のパーティションの読み取り専用コピーをホストするドメインコントローラーです。 Rodc は、他のドメインコントローラーに変更をレプリケートしないため、ほとんどの USN ロールバックの問題を回避します。 ただし、RODC が、USN ロールバックの影響を受けた書き込み可能なドメインコントローラーからレプリケートする場合、RODC も影響を受けます。

スナップショットを使用して RODC を復元することはお勧めできません。 Active Directory 互換のバックアップアプリケーションを使用して RODC を復元します。 また、書き込み可能なドメインコントローラーと同様に、廃棄 (tombstone) の有効期間が経過するまで RODC をオフラインにできないように注意する必要があります。 この状態になると、RODC で残留オブジェクトが発生する可能性があります。

Rodc の詳細については、「 [読み取り専用ドメインコントローラーの計画と展開ガイド](../../deploy/rodc/read-only-domain-controller-updates.md)」を参照してください。
