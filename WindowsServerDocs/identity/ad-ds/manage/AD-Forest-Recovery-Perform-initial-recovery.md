---
title: AD フォレストの回復-最初の回復を実行する
ms.author: daveba
author: iainfoulds
manager: daveba
ms.date: 08/09/2018
ms.topic: article
ms.assetid: 5a291f65-794e-4fc3-996e-094c5845a383
ms.openlocfilehash: 8b0498b30966c22ec8dca267988e109d976f6b69
ms.sourcegitcommit: b115e5edc545571b6ff4f42082cc3ed965815ea4
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/30/2020
ms.locfileid: "93067744"
---
# <a name="perform-initial-recovery"></a>初期回復の実行

>適用対象: Windows Server 2016、Windows Server 2012、および 2012 R2、Windows Server 2008 および 2008 R2

このセクションには、次の手順が記載されています。

- [各ドメイン内の最初の書き込み可能なドメインコントローラーを復元する](#restore-the-first-writeable-domain-controller-in-each-domain)
- [復元した各書き込み可能ドメインコントローラーをネットワークに再接続します](#reconnect-each-restored-writeable-domain-controller-to-a-common-network)
- [フォレストルートドメイン内のドメインコントローラーにグローバルカタログを追加する](#add-the-global-catalog-to-a-domain-controller-in-the-forest-root-domain)

## <a name="restore-the-first-writeable-domain-controller-in-each-domain"></a>各ドメイン内の最初の書き込み可能なドメインコントローラーを復元する

最初の DC を復元するために、このセクションの手順を実行して、フォレストルートドメインの書き込み可能 DC を開始します。 フォレストルートドメインは、Schema Admins グループと Enterprise Admins グループを格納するため、重要です。 また、フォレスト内の信頼階層を維持するのにも役立ちます。 また、フォレストのルートドメインは、通常、フォレストの DNS 名前空間の DNS ルートサーバーを保持します。 そのため、そのドメインの Active Directory 統合 DNS ゾーンには、(レプリケーションに必要な) フォレスト内の他のすべての Dc のエイリアス (CNAME) リソースレコードと、グローバルカタログの DNS リソースレコードが含まれます。

フォレストルートドメインを回復した後、同じ手順を繰り返して、フォレスト内の残りのドメインを回復します。 複数のドメインを同時に復旧できます。ただし、信頼階層または DNS 名前解決の中断を防ぐために、子を回復する前に常に親ドメインを回復するようにしてください。

回復するドメインごとに、バックアップから書き込み可能な DC を1つだけ復元します。 これは、DC がフォレストの障害の原因によって影響を受けていないデータベースを持っている必要があるため、回復の最も重要な部分です。 実稼働環境に導入される前に、完全にテストされた信頼できるバックアップを用意することが重要です。

次に、以下の手順のようにします。 特定の手順を実行する手順については [、「AD フォレストの回復手順](AD-Forest-Recovery-Procedures.md)」を確認してください。

1. 物理サーバーを復元する場合は、ターゲット DC のネットワークケーブルが接続されていないため、実稼働ネットワークに接続されていないことを確認してください。 仮想マシンの場合、ネットワークアダプターを削除するか、別のネットワークに接続されているネットワークアダプターを使用して、運用ネットワークから分離した状態で回復プロセスをテストすることができます。

2. これはドメイン内の最初の書き込み可能 DC なので、AD DS の権限のない復元と SYSVOL の authoritative restore を実行する必要があります。 復元操作は、Windows Server バックアップなどの Active Directory 対応のバックアップおよび復元アプリケーションを使用して完了する必要があります (つまり、VM スナップショットの復元など、サポートされていない方法を使用して DC を復元することはできません)。
   - Sysvol レプリケートフォルダーのレプリケーションは、障害から回復した後に開始する必要があるため、authoritative restore を実行する必要があります。 ドメインに追加されたそれ以降のすべての Dc は、SYSVOL フォルダーを、フォルダーを提供する前に、権限があると選択されたフォルダーのコピーで再同期する必要があります。

   > [!CAUTION]
   > フォレストルートドメインで復元される最初の DC に対してのみ、SYSVOL の権限のある (またはプライマリ) 復元操作を実行します。 他の Dc で SYSVOL のプライマリ復元操作を誤って実行すると、SYSVOL データのレプリケーションの競合が生じます。

   - AD DS の権限のない復元と SYSVOL の authoritative restore を実行するには、次の2つのオプションがあります。
   - サーバーの完全復旧を実行し、SYSVOL の権限のある同期を強制します。 詳細な手順については、「 [フルサーバー回復の実行](AD-Forest-Recovery-Perform-a-Full-Recovery.md) 」と「 [DFSR によってレプリケートされた SYSVOL の権限の同期の実行](AD-Forest-Recovery-Authoritative-Recovery-SYSVOL.md)」を参照してください。
   - サーバーの完全復旧を実行し、その後にシステム状態の復元を実行します。 このオプションを使用するには、完全なサーバーバックアップとシステム状態のバックアップの両方の種類のバックアップを事前に作成する必要があります。 詳細な手順については、「 [サーバーの完全復旧を実行](AD-Forest-Recovery-Perform-a-Full-Recovery.md) し、 [Active Directory Domain Services の権限のない復元を実行](AD-Forest-Recovery-Nonauthoritative-Restore.md)する」を参照してください。

3. 書き込み可能 DC を復元して再起動した後、障害が DC のデータに影響していないことを確認します。 DC データが破損している場合は、別のバックアップを使用して手順 2. を繰り返します。
   - 復元されたドメインコントローラーが操作マスターの役割をホストしている場合は、書き込み可能なディレクトリパーティションのレプリケーションが完了するまで AD DS 使用できないようにするために、次のレジストリエントリを追加する必要がある場合があります。

      **HKLM\System\CurrentControlSet\Services\NTDS\Parameters\Repl 初期同期の実行**

      データ型が **REG_DWORD** で、値が **0** のエントリを作成します。 フォレストが完全に回復したら、このエントリの値を **1** にリセットできます。これには、既知のレプリカパートナーとの受信および送信レプリケーションを正常に実行するために、操作マスターの役割を再起動して、クライアントへのサービスの提供を開始する前に、操作マスターの役割を正常に AD DS するために、操作マスターの役割を 初期同期要件の詳細については、サポート技術情報の記事 [305476](https://support.microsoft.com/kb/305476)を参照してください。

      データを復元して検証してから、このコンピューターを実稼働ネットワークに参加させる前に、次の手順に進みます。

4. フォレスト全体の障害がネットワークの侵入や悪意のある攻撃に関連していると思われる場合は、Enterprise Admins、Domain Admins、Schema Admins、Server Operators、Account Operators グループなどのすべての管理者アカウントのアカウントパスワードをリセットします。 管理アカウントのパスワードのリセットは、フォレストの回復の次のフェーズで、追加のドメインコントローラーをインストールする前に完了する必要があります。
5. フォレストルートドメイン内の最初に復元された DC で、すべてのドメイン全体およびフォレスト全体の操作マスターの役割を強制します。 フォレスト全体の操作マスターの役割を強制するには、Enterprise Admins および Schema Admins の資格情報が必要です。

     各子ドメインで、ドメイン全体の操作マスターの役割を強制します。 操作マスターの役割は復元された DC に一時的にのみ保持される場合がありますが、これらの役割を強制することで、フォレストの回復プロセスでどの DC がこの時点でホストしているかを確認できます。 回復後のプロセスの一部として、必要に応じて操作マスターの役割を再配布できます。 操作マスターの役割の強制の詳細については、「 [操作マスターの役割の強制](AD-forest-recovery-seizing-operations-master-role.md)」を参照してください。 操作マスターの役割を配置する場所に関する推奨事項については、「 [操作マスターとは](/previous-versions/windows/it-pro/windows-server-2003/cc779716(v=ws.10))」を参照してください。

6. バックアップから復元していない、フォレストルートドメイン内の他のすべての書き込み可能な Dc のメタデータをクリーンアップします (この最初の DC を除く、ドメイン内のすべての書き込み可能な Dc)。 Active Directory ユーザーとコンピューター、または Windows Server 2008 以降または Windows Vista 以降に含まれている Active Directory サイトおよびサービスのバージョンを使用する場合、DC オブジェクトを削除すると、メタデータのクリーンアップが自動的に実行されます。 また、削除された DC のサーバーオブジェクトとコンピューターオブジェクトも自動的に削除されます。 詳細については、「 [削除された書き込み可能 dc のメタデータのクリーニング](AD-Forest-Recovery-Cleaning-Metadata.md)」を参照してください。

     別のサイトの DC に AD DS がインストールされている場合、メタデータをクリーンアップすることで、NTDS 設定オブジェクトが重複しないようにすることができます。 場合によっては、Dc 自体が存在しない場合に、知識整合性チェッカー (KCC) によってレプリケーションリンクを作成するプロセスが保存されることもあります。 さらに、メタデータのクリーンアップの一部として、ドメイン内の他のすべての Dc の DC ロケーター DNS リソースレコードは、DNS から削除されます。

     ドメイン内の他のすべての Dc のメタデータが削除されるまで、この DC は、回復前の RID マスターの場合、RID マスターの役割を担いません。したがって、新しい Rid を発行することはできません。 このエラーを示すイベントビューアーシステムログにイベント ID 16650 が表示される場合がありますが、メタデータをクリーンアップした後、イベント ID 16648 が成功したことを示すイベント ID が表示されます。

7. AD DS に格納されている DNS ゾーンがある場合は、復元した DC にローカル DNS サーバーサービスがインストールされ、実行されていることを確認します。 フォレストに障害が発生する前にこの DC が DNS サーバーでない場合は、DNS サーバーをインストールして構成する必要があります。

    > [!NOTE]
    > 復元された DC が Windows Server 2008 を実行している場合は、サポート技術情報の記事 [975654](https://support.microsoft.com/kb/975654) に記載されている修正プログラムをインストールするか、DNS サーバーをインストールするためにサーバーを一時的に分離されたネットワークに接続する必要があります。 この修正プログラムは、Windows Server の他のバージョンには必要ありません。

     フォレストルートドメインで、復元された DC の IP アドレス (または、127.0.0.1 などのループバックアドレス) を優先 DNS サーバーとして構成します。 この設定は、ローカルエリアネットワーク (LAN) アダプターの TCP/IP プロパティで構成できます。 これは、フォレスト内の最初の DNS サーバーです。 詳細については、「 [DNS を使用するための tcp/ip の構成](/previous-versions/windows/it-pro/windows-server-2003/cc779716(v=ws.10))」を参照してください。

     各子ドメインで、復元された DC を、優先 DNS サーバーとして、フォレストルートドメイン内の最初の DNS サーバーの IP アドレスで構成します。 この設定は、LAN アダプターの TCP/IP プロパティで構成できます。 詳細については、「 [DNS を使用するための tcp/ip の構成](/previous-versions/windows/it-pro/windows-server-2003/cc779716(v=ws.10))」を参照してください。

     [_Msdcs とドメインの DNS ゾーン] で、メタデータのクリーンアップ後に存在しなくなった Dc の NS レコードを削除します。 クリーンアップした Dc の SRV レコードが削除されているかどうかを確認します。 DNS SRV レコードの削除を高速化するために、次のように実行します。

    ```
    nltest.exe /dsderegdns:server.domain.tld
    ```

8. 使用可能な RID プールの値を10万で累乗します。 詳細については、「 [使用可能な RID プールの値を上げる](AD-Forest-Recovery-Raise-RID-Pool.md)」を参照してください。 RID プールを10万で上げることが特定の状況では不十分であると考えられる理由がある場合は、使用した方が安全であることを確認する必要があります。 Rid は有限のリソースであり、不必要に使用するべきではありません。

     復元に使用するバックアップの実行後にドメインに新しいセキュリティプリンシパルが作成された場合、これらのセキュリティプリンシパルは特定のオブジェクトに対するアクセス権を持っている可能性があります。 回復がバックアップに戻されたため、これらのセキュリティプリンシパルは復旧後に存在しなくなりました。ただし、アクセス権はまだ存在している可能性があります。 復元後に使用可能な RID プールが生成されない場合、フォレストの回復後に作成された新しいユーザーオブジェクトは、同一のセキュリティ Id (Sid) を取得し、本来は意図されていなかったオブジェクトにアクセスできる可能性があります。

     例として、「説明」で説明した「Amy」という名前の新しい従業員の例を考えてみましょう。 復元操作の後、Amy のユーザーオブジェクトは、ドメインの復元に使用されたバックアップの後に作成されたため、もう存在しません。 ただし、そのユーザーオブジェクトに割り当てられたアクセス権は、復元操作後も保持される可能性があります。 復元操作後にそのユーザーオブジェクトの SID が新しいオブジェクトに再割り当てされた場合、新しいオブジェクトはそれらのアクセス権を取得します。

9. 現在の RID プールを無効にします。 システム状態の復元後、現在の RID プールは無効になります。 ただし、システム状態の復元が実行されていない場合は、復元された DC がバックアップの作成時に割り当てられた RID プールから rid を再発行するのを防ぐために、現在の RID プールを無効にする必要があります。 詳細については、「 [現在の RID プールを無効にする](AD-Forest-Recovery-Invaildate-RID-Pool.md)」を参照してください。

    > [!NOTE]
    > RID プールを無効にした後で、SID を使用してオブジェクトを初めて作成しようとすると、エラーが発生します。 オブジェクトを作成しようとすると、新しい RID プールの要求がトリガーされます。 新しい RID プールが割り当てられるため、操作の再試行は成功します。

10. この DC のコンピューターアカウントのパスワードを2回リセットします。 詳細については、「 [ドメインコントローラーのコンピューターアカウントのパスワードをリセットする](AD-Forest-Recovery-Reset-Computer-Account-DC.md)」を参照してください。

11. Krbtgt パスワードを2回リセットします。 詳細については、「 [krbtgt パスワードのリセット](AD-Forest-Recovery-Resetting-the-krbtgt-password.md)」を参照してください。

     Krbtgt パスワードの履歴は2つのパスワードであるため、パスワードを2回リセットして、パスワードの履歴から元の (prefailure) パスワードを削除します。

    > [!NOTE]
    > フォレストの回復がセキュリティ侵害に応えている場合は、信頼されたパスワードをリセットすることもできます。 詳細については、「信頼 [の1側での信頼パスワードのリセット](AD-Forest-Recovery-Reset-Trust.md)」を参照してください。

12. フォレストに複数のドメインがあり、障害が発生する前に復元された DC がグローバルカタログサーバーであった場合は、[NTDS 設定のプロパティ] の [ **グローバルカタログ** ] チェックボックスをオフにして、dc からグローバルカタログを削除します。 この規則の例外は、ドメインが1つだけのフォレストの場合に一般的です。 この場合、グローバルカタログを削除する必要はありません。 詳細については、「 [グローバルカタログの削除](AD-Forest-Recovery-Remove-GC.md)」を参照してください。

     他のドメインの Dc を復元するために使用される他のバックアップよりも新しいバックアップからグローバルカタログを復元する場合は、残留オブジェクトを導入することがあります。 各データ メンバー フィールドが JSON オブジェクトにマップされ、フィールド名がオブジェクトの "key" 部分にマップされ、"value" 部分がオブジェクトの値の部分に再帰的にマップされます。 ドメイン A では、時刻 T1 で取得されたバックアップから DC1 が復元されます。 ドメイン B では、DC2 は時刻 T2 に作成されたグローバルカタログバックアップから復元されます。 T2 が T1 よりも新しい場合、T1 と T2 の間にいくつかのオブジェクトが作成されたとします。 これらの Dc が復元された後、DC2 はグローバルカタログであり、ドメイン A が自身を保持するのではなく、ドメイン A の部分レプリカの新しいデータが保持されます。 この場合、DC2 は、これらのオブジェクトが DC1 に存在しないため、残留オブジェクトを保持します。

     残留オブジェクトが存在すると、問題が発生する可能性があります。 たとえば、ユーザーオブジェクトがドメイン間で移動されたユーザーに電子メールメッセージが配信されない可能性があります。 古くなった DC またはグローバルカタログサーバーをオンラインに戻すと、両方のユーザーオブジェクトのインスタンスがグローバルカタログに表示されます。 両方のオブジェクトが同じ電子メールアドレスを持っています。そのため、電子メールメッセージを配信できません。

     もう1つの問題は、存在しなくなったユーザーアカウントが依然としてグローバルアドレス一覧に表示される可能性があることです。 3番目の問題は、存在しなくなったユニバーサルグループがユーザーのアクセストークンにまだ表示されている可能性があることです。

     グローバルカタログである DC を誤って、または信頼できる唯一のバックアップとして復元した場合は、復元操作の完了後すぐにグローバルカタログを無効にすることで、残留オブジェクトが発生しないようにすることをお勧めします。 グローバルカタログフラグを無効にすると、コンピューターはすべての部分的なレプリカ (パーティション) を失い、relegating 自体が通常の DC の状態になります。

13. Windows タイムサービスを構成します。 フォレストルートドメインで、外部タイムソースから時刻を同期するように PDC エミュレーターを構成します。 詳細については、「 [フォレストルートドメインの PDC エミュレーターで Windows タイムサービスを構成する](/previous-versions/windows/it-pro/windows-server-2008-r2-and-2008/cc731191%28v=ws.10%29)」を参照してください。

## <a name="reconnect-each-restored-writeable-domain-controller-to-a-common-network"></a>復元した各書き込み可能ドメインコントローラーを共通ネットワークに再接続する

この段階では、フォレストルートドメインと残りの各ドメインに1つの DC (および回復手順) が復元されている必要があります。 これらの Dc を環境の他の部分から分離された共通ネットワークに参加させ、フォレストの正常性とレプリケーションを検証するために次の手順を実行します。

> [!NOTE]
> 物理 Dc を分離されたネットワークに参加させる場合、IP アドレスの変更が必要になることがあります。 このため、DNS レコードの IP アドレスは間違っています。 グローバルカタログサーバーは使用できないため、セキュリティで保護された DNS の動的更新は失敗します。 この場合、仮想 Dc は、IP アドレスを変更せずに新しい仮想ネットワークに参加できるため、より便利です。 これは、フォレストの回復中に復元する最初のドメインコントローラーとして仮想 Dc を推奨する理由の1つです。

検証後、Dc を運用ネットワークに参加させ、フォレストレプリケーションの正常性を確認する手順を完了します。

- 名前解決を修正するには、DNS 委任レコードを作成し、必要に応じて DNS 転送とルートヒントを構成します。 **Repadmin/replsum** を実行して、dc 間のレプリケーションを確認します。
- 復元された DC が直接レプリケーションパートナーでない場合、レプリケーションの復旧は、それらの間に一時的な接続オブジェクトを作成することによってはるかに高速になります。
- メタデータのクリーンアップを検証するには、 **Repadmin/viewlist \\** _ を実行し、フォレスト内のすべての dc の一覧を表示します。 ドメイン内のすべての dc の一覧を表示するには、_ *Nltest/DCList:* *  *\><ドメイン* を実行します。
- DC と DNS の正常性を確認するには、DCDiag/v を実行して、フォレスト内のすべての Dc でエラーを報告します。

## <a name="add-the-global-catalog-to-a-domain-controller-in-the-forest-root-domain"></a>フォレストルートドメイン内のドメインコントローラーにグローバルカタログを追加する

グローバルカタログは、次のような理由で必要です。

- ユーザーのログオンを有効にします。
- 各子ドメインの Dc で実行されている Net Logon サービスを有効にして、ルートドメイン内の DNS サーバーのレコードを登録および削除すること。

フォレストルート DC はグローバルカタログにすることをお勧めしますが、復元されたいずれかの Dc をグローバルカタログとして選択することもできます。

> [!NOTE]
> DC は、フォレスト内のすべてのディレクトリパーティションの完全同期を完了するまで、グローバルカタログサーバーとしてアドバタイズされません。 そのため、DC は、フォレスト内の復元された各 Dc を使用して強制的にレプリケートする必要があります。
>
> イベント ID 1119 のディレクトリサービスイベントイベントビューアーログを監視します。これは、この DC がグローバルカタログサーバーであることを示します。または、次のレジストリキーの値が1であることを確認します。
>
> **HKLM\System\CurrentControlSet\Services\NTDS\Parameters\Global カタログの昇格が完了しました**

詳細については、「 [グローバルカタログの追加](AD-Forest-Recovery-Add-GC.md)」を参照してください。

この段階では、安定したフォレストがあり、ドメインごとに1つの DC とフォレスト内に1つのグローバルカタログが存在している必要があります。 復元した各 Dc の新しいバックアップを作成する必要があります。 AD DS をインストールすることによって、フォレスト内の他の Dc の再デプロイを開始できるようになりました。

## <a name="next-steps"></a>次の手順

- [AD フォレストの回復 - 前提条件](AD-Forest-Recovery-Prerequisties.md)
- [AD フォレストの回復-カスタムフォレストの復旧計画の作成](AD-Forest-Recovery-Devising-a-Plan.md)
- [AD フォレストの回復-問題の特定](AD-Forest-Recovery-Identify-the-Problem.md)
- [AD フォレストの回復-回復方法を決定する](AD-Forest-Recovery-Determine-how-to-Recover.md)
- [AD フォレストの回復-最初の回復を実行する](AD-Forest-Recovery-Perform-initial-recovery.md)
- [AD フォレストの回復 - 手順](AD-Forest-Recovery-Procedures.md)
- [AD フォレストの回復-よく寄せられる質問](AD-Forest-Recovery-FAQ.md)
- [AD フォレストの回復-マルチドメインフォレスト内の単一ドメインの回復](AD-Forest-Recovery-Single-Domain-in-Multidomain-Recovery.md)
- [AD フォレストの回復-Windows Server 2003 ドメインコントローラーを使用したフォレストの回復](AD-Forest-Recovery-Windows-Server-2003.md)
