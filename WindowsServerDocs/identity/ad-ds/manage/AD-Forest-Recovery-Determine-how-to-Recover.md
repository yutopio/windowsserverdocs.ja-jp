---
description: 詳細については、「フォレストの回復方法の決定」を参照してください。
title: AD フォレストの回復-フォレストを回復する方法を決定する
ms.author: daveba
author: iainfoulds
manager: daveba
ms.date: 08/09/2018
ms.topic: article
ms.assetid: 5a291f65-794e-4fc3-996e-094c5845a383
ms.openlocfilehash: 15d05a5c37b81fe059fcb2b0be111fd694bd3f57
ms.sourcegitcommit: 65b6de6b44d41f1180c45db11cdd60cb2a093b46
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 12/10/2020
ms.locfileid: "97045630"
---
# <a name="determine-how-to-recover-the-forest"></a>フォレストを回復する方法を決定する

>適用対象: Windows Server 2016、Windows Server 2012、および 2012 R2、Windows Server 2008 および 2008 R2

Active Directory フォレスト全体を回復するには、バックアップから復元するか、フォレスト内のすべてのドメインコントローラー (DC) に Active Directory Domain Services (AD DS) を再インストールする必要があります。 フォレストを回復すると、フォレスト内の各ドメインが、最後に信頼されたバックアップの時点の状態に復元されます。 その結果、復元操作によって少なくとも次の Active Directory データが失われます。

- 最後に信頼されたバックアップの後に追加されたすべてのオブジェクト (ユーザーやコンピューターなど)
- 最後に信頼されたバックアップ以降に既存のオブジェクトに対して行われたすべての更新
- 最後に信頼されたバックアップ以降に構成パーティションまたはスキーマパーティションに対して行われたすべての変更 (スキーマの変更など) は、AD DS ます。

フォレスト内のドメインごとに、ドメイン管理者アカウントのパスワードがわかっている必要があります。 これは、組み込みの Administrator アカウントのパスワードです。 DC のシステム状態の復元を実行するには、DSRM パスワードも必要です。 一般に、バックアップが有効である (つまり、Active Directory のごみ箱が有効になっている場合は、廃棄済みオブジェクトの有効期間内または削除されたオブジェクトの有効期間内である限り) ため、管理者アカウントと DSRM パスワードの履歴を安全な場所に保管することをお勧めします。 覚えやすいように、DSRM パスワードをドメインユーザーアカウントと同期することもできます。 詳細については、サポート技術情報の記事 [961320](https://support.microsoft.com/kb/961320)を参照してください。 DSRM アカウントの同期は、準備の一環として、フォレストの回復よりも前に行う必要があります。

> [!NOTE]
> Administrator アカウントは、既定では、Domain Admins グループおよび Enterprise Admins グループと同様に、組み込みの Administrators グループのメンバーです。 このグループには、ドメイン内のすべての Dc を完全に制御できます。

## <a name="determining-which-backups-to-use"></a>使用するバックアップの決定

各ドメインに対して少なくとも2つの書き込み可能な Dc を定期的にバックアップして、複数のバックアップを選択できるようにします。 読み取り専用ドメインコントローラー (RODC) のバックアップを使用して、書き込み可能 DC を復元することはできないことに注意してください。 障害が発生するまで数日前に作成されたバックアップを使用して、Dc を復元することをお勧めします。 通常は、復元されたデータの recentness と safeness の間のトレードオフを確認する必要があります。 より新しいバックアップを選択すると、より有用なデータが回復されますが、危険なデータを復元されたフォレストに再導入リスクが増える可能性があります。

システム状態のバックアップの復元は、バックアップの元のオペレーティングシステムとサーバーに依存します。 たとえば、システム状態のバックアップを別のサーバーに復元することは避けてください。 この場合、次の警告が表示されることがあります。

"指定されたバックアップは、現在のバックアップとは別のサーバーのものです。 サーバーが使用できなくなる可能性があるため、代替サーバーへのバックアップによるシステム状態の回復を実行することはお勧めしません。 このバックアップを使用して現在のサーバーを回復しますか? "

Active Directory を別のハードウェアに復元する必要がある場合は、サーバーの完全バックアップを作成し、サーバーの完全復旧を実行するように計画します。

> [!IMPORTANT]
> Windows Server 2008 以降では、新しいハードウェアまたは同じハードウェア上で Windows Server の新しいインストールにシステム状態のバックアップを復元することはサポートされていません。 Windows Server を同じハードウェアに再インストールする場合は、このガイドの後半で推奨されているように、ドメインコントローラーを次の順序で復元できます。
>
> 1. オペレーティングシステムとすべてのファイルとアプリケーションを復元するために、サーバーの完全復元を実行します。
> 2. SYSVOL を権限のあるものとしてマークするために wbadmin.exe を使用してシステム状態の復元を実行します。
>
> 詳細については、マイクロソフトサポート技術情報の記事 [249694](https://support.microsoft.com/kb/249694)を参照してください。

エラーが発生した時刻が不明な場合は、さらに調査して、フォレストの最後の安全な状態を保持しているバックアップを特定します。 この方法は、あまり好ましくありません。 したがって、AD DS の正常性状態に関する詳細なログを毎日保持しておくことを強くお勧めします。これにより、フォレスト全体で障害が発生した場合に、おおよその障害が特定されます。 また、迅速な回復を可能にするために、バックアップのローカルコピーも保持する必要があります。

Active Directory のごみ箱が有効になっている場合、バックアップの有効期間は **msds-deletedobjectlifetime** 値または **tombstoneLifetime** 値のいずれか小さい方と等しくなります。 詳細については、 [Active Directory ごみ箱のステップバイステップガイド](https://go.microsoft.com/fwlink/?LinkId=178657) () を参照してください https://go.microsoft.com/fwlink/?LinkId=178657) 。

別の方法として、Active Directory データベースマウントツール (Dsamain.exe) とライトウェイトディレクトリアクセスプロトコル (LDAP) ツール (Ldp.exe または Active Directory ユーザーとコンピューターなど) を使用して、どのバックアップにどのバックアップが最後に安全な状態にあるかを特定することもできます。 Active Directory データベースマウントツールは、Windows server 2008 以降の Windows Server オペレーティングシステムに含まれており、LDAP サーバーとしてバックアップまたはスナップショットに格納されている Active Directory データを公開します。 次に、LDAP ツールを使用してデータを参照できます。 このアプローチには、ディレクトリサービス復元モード (DSRM) で DC を再起動して AD DS のバックアップの内容を確認する必要がないという利点があります。

Active Directory データベースマウントツールの使用方法の詳細については、「 [Active Directory データベースマウントツールのステップバイステップガイド](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc771232(v=ws.10))」を参照してください。

また、 **ntdsutil snapshot** コマンドを使用して、Active Directory データベースのスナップショットを作成することもできます。 定期的にスナップショットを作成するようにタスクをスケジュールすることで、Active Directory データベースの追加のコピーを時間の経過と共に取得できます。 これらのコピーを使用して、フォレスト全体の障害が発生したことをより明確に識別し、復元する最適なバックアップを選択することができます。 スナップショットを作成するには、Windows Server 2008 に付属しているバージョンの **ntdsutil** 、または windows Vista 以降のリモートサーバー管理ツール (RSAT) を使用します。 ターゲット DC は、任意のバージョンの Windows Server を実行できます。 **Ntdsutil snapshot** コマンドの使用方法の詳細については、「 [snapshot](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc771232(v=ws.10))」を参照してください。

## <a name="determining-which-domain-controllers-to-restore"></a>復元するドメインコントローラーを決定する

復元プロセスの容易さは、復元するドメインコントローラーを決定する際の重要な要素です。 復元に優先される DC をドメインごとに専用の DC にすることをお勧めします。 専用の復元 DC を使用すると、復元テストの実行に使用されたのと同じソース構成を使用するため、フォレストの回復をより確実に計画および実行できます。 復旧のスクリプトを作成し、DC が操作マスターの役割を保持しているかどうか、GC または DNS サーバーであるかどうかなど、異なる構成を使用して対処することはできません。

> [!NOTE]
> 操作マスターの役割の所有者をわかりやすくするために復元することは推奨されていませんが、組織によっては、他の利点のために復元することを選択できます。 たとえば、RID マスターを復元すると、復旧中に Rid を管理する際に問題が発生するのを防ぐことができます。

次の条件に最も適合する DC を選択します。

- 書き込み可能な DC。 これは必須です。

- Windows Server 2012 を実行している DC は、Vm-generationid をサポートするハイパーバイザー上で仮想マシンとして動作します。 この DC は、複製のソースとして使用できます。
- 物理的または仮想ネットワーク上のアクセス可能な DC。可能であれば、データセンター内に配置します。 これにより、フォレストの回復中にネットワークから簡単に分離することができます。
- 正常なサーバーの完全バックアップを持つ DC。 優れたバックアップとは、正常に復元できるバックアップで、障害が発生するまで数日前に作成されており、可能な限り多くの有益なデータが含まれています。
- 障害が発生する前にドメインネームシステム (DNS) サーバーであった DC。 これにより、DNS を再インストールするために必要な時間が短縮されます。
- Windows 展開サービスも使用する場合は、BitLocker ネットワークロック解除を使用するように構成されていない DC を選択します。 この場合、フォレストの回復中にバックアップから復元する最初の DC に対して、BitLocker ネットワークロック解除を使用することはできません。

   BitLocker ネットワークロック解除は *、Windows 展開サービス* (wds) を展開した dc では使用 *できません* 。これは、最初の dc がロックを解除するために Active Directory と WDS が動作することを必要とするシナリオになるためです。 ただし、最初の DC を復元する前に、Active Directory は WDS ではまだ使用できないため、ロックを解除できません。

   DC が BitLocker ネットワークロック解除を使用するように構成されているかどうかを判断するには、次のレジストリキーでネットワークロック解除証明書が指定されていることを確認します。

   HKEY_LOCAL_MACHINESoftwarePoliciesMicrosoftSystemCertificatesFVE_NKP

Active Directory を含むバックアップファイルを処理または復元するときに、セキュリティ手順を維持します。 フォレスト回復に付随する緊急度は、意図せずに見落としのセキュリティのベストプラクティスにつながる可能性があります。 詳細については、「 [Active Directory のインストールをセキュリティで保護するためのベストプラクティスガイド](/previous-versions/windows/it-pro/windows-2000-server/bb727066(v=technet.10))」の「ドメインコントローラーのバックアップと復元の戦略の確立」、および「パート II」を参照してください。

## <a name="identify-the-current-forest-structure-and-dc-functions"></a>現在のフォレスト構造と DC 関数を識別する

フォレスト内のすべてのドメインを特定して、現在のフォレスト構造を確認します。 各ドメインのすべての Dc (特に、バックアップがある Dc) と、複製のソースとして使用できる仮想化 Dc の一覧を作成します。 フォレストルートドメインの Dc の一覧が最も重要なのは、このドメインを最初に回復するためです。 フォレストルートドメインを復元した後、Active Directory スナップインを使用して、フォレスト内の他のドメイン、Dc、およびサイトの一覧を取得できます。

次の例に示すように、ドメイン内の各 DC の機能を表示するテーブルを準備します。 これにより、回復後にフォレストの障害前の構成に戻すことができます。

|DC 名|オペレーティング システム|FSMO|[GC]|RODC|バックアップ|DNS|Server Core|VM|VM-GenID|
|-------------|----------------------|----------|--------|----------|------------|---------|-----------------|--------|---------------|
|DC_1|Windows Server 2012|スキーママスタ、ドメイン名前付けマスタ|はい|いいえ|はい|いいえ|いいえ|はい|はい|
|DC_2|Windows Server 2012|なし|はい|いいえ|はい|はい|いいえ|はい|はい|
|DC_3|Windows Server 2012|インフラストラクチャ マスタ|いいえ|いいえ|いいえ|はい|はい|はい|はい|
|DC_4|Windows Server 2012|PDC エミュレーター、RID マスター|はい|いいえ|いいえ|いいえ|いいえ|はい|いいえ|
|DC_5|Windows Server 2012|なし|いいえ|いいえ|はい|はい|いいえ|はい|はい|
|RODC_1|Windows Server 2008 R2|なし|はい|はい|はい|はい|はい|はい|いいえ|
|RODC_2|Windows Server 2008|なし|はい|はい|いいえ|はい|はい|はい|いいえ|

フォレスト内のドメインごとに、そのドメインの Active Directory データベースの信頼されたバックアップを持つ、1つの書き込み可能 DC を識別します。 DC を復元するバックアップを選択するときは、注意してください。 障害の日と原因がほぼわかっている場合、一般的な推奨事項は、その日の前に数日前に作成されたバックアップを使用することです。

この例では、DC_1、DC_2、DC_4、および DC_5 の4つのバックアップ候補があります。 これらのバックアップ候補のうち、1つだけ復元します。 推奨される DC は、次の理由により DC_5 ます。

- これは、仮想化された DC の複製のソースとして使用するための要件を満たしています。つまり、Vm-generationid をサポートするハイパーバイザー上の仮想 DC として Windows Server 2012 を実行し、複製が許可されているソフトウェア (または複製できない場合は削除可能) を実行します。 復元が完了すると、PDC エミュレーターの役割がそのサーバーに強制され、ドメインの複製可能なドメインコントローラーグループに追加できるようになります。
- Windows Server 2012 の完全インストールを実行します。 Server Core インストールを実行している DC は、回復の対象としてはあまり便利ではありません。
- これは DNS サーバーです。 そのため、DNS を再インストールする必要はありません。

> [!NOTE]
> DC_5 はグローバルカタログサーバーではないため、復元後にグローバルカタログを削除する必要がないという利点もあります。 ただし、DC がグローバルカタログサーバーでもあるかどうかは、Windows Server 2012 以降では、すべての Dc が既定でグローバルカタログサーバーになり、どのような場合でも、フォレストの復旧プロセスの一部として、復元後にグローバルカタログを削除して追加することをお勧めします。

## <a name="recover-the-forest-in-isolation"></a>フォレストを分離して回復する

最初の復元された DC が運用環境に復帰する前に、すべての書き込み可能な Dc をシャットダウンすることをお勧めします。 これにより、危険なデータが回復したフォレストにレプリケートされないようにすることができます。 特に、すべての操作マスターの役割所有者をシャットダウンすることが重要です。

> [!NOTE]
> 場合によっては、システムのダウンタイムを最小限に抑えるために、ドメインごとに回復する予定の最初の DC を分離されたネットワークに移動し、他の dc はオンラインのままにすることができます。 たとえば、失敗したスキーマのアップグレードから回復する場合は、復旧手順を分離して実行しながら、運用ネットワークでドメインコントローラーを実行し続けることを選択できます。

仮想化 Dc を実行している場合は、回復を実行する運用ネットワークから分離された仮想ネットワークに移動できます。 仮想化 Dc を別のネットワークに移動すると、次の2つの利点があります。

- 回復された Dc は、孤立しているために、フォレストの回復の原因となった問題の再発を防ぎます。
- 仮想化 DC の複製は、独立したネットワークで実行できます。これにより、運用ネットワークに戻される前に、多数の Dc の実行とテストが可能になります。

物理ハードウェアで Dc を実行している場合は、フォレストのルートドメイン内で復元を計画している最初の DC のネットワークケーブルを切断します。 可能であれば、他のすべての Dc のネットワークケーブルも切断します。 これにより、フォレストの回復プロセスで Dc が誤って開始された場合に、Dc がレプリケートされるのを防ぐことができます。

複数の場所に分散されている大規模なフォレストでは、書き込み可能なすべての Dc がシャットダウンされることを保証することが困難な場合があります。 このため、メタデータのクリーンアップに加えて、コンピューターアカウントや krbtgt アカウントのリセットなどの回復手順は、回復された書き込み可能 Dc が危険な書き込み可能 Dc を使用してレプリケートされないように設計されています (フォレスト内の一部がまだオンラインになっている場合)。

ただし、書き込み可能な Dc をオフラインにすることによってのみ、レプリケーションが行われないことを保証できます。 そのため、可能な限り、リモート管理テクノロジを展開して、フォレストの回復中に書き込み可能な Dc をシャットダウンし、物理的に分離することができます。

Rodc は、書き込み可能な Dc がオフラインの間も動作を継続できます。 他の DC はどの RODC からも変更を直接レプリケートしません。特に、スキーマや構成コンテナーの変更はありません。そのため、復旧中に書き込み可能 Dc と同じリスクが生じることはありません。 書き込み可能なすべての Dc が復旧され、オンラインになったら、すべての Rodc を再構築する必要があります。

Rodc は、回復操作が並列で実行されている間、それぞれのサイトにキャッシュされているローカルリソースへのアクセスを引き続き許可します。 RODC にキャッシュされていないローカルリソースには、書き込み可能 DC に転送される認証要求が含まれます。 書き込み可能な Dc がオフラインであるため、これらの要求は失敗します。 また、パスワードの変更などの一部の操作は、書き込み可能な Dc を回復するまで機能しません。

ハブとスポークのネットワークアーキテクチャを使用している場合は、最初にハブサイトの書き込み可能な Dc の回復に専念できます。 後で、リモートサイトで Rodc を再構築できます。

## <a name="next-steps"></a>次の手順

- [AD フォレストの回復 - 前提条件](AD-Forest-Recovery-Prerequisties.md)
- [AD フォレストの回復-カスタムフォレストの復旧計画の作成](AD-Forest-Recovery-Devising-a-Plan.md)
- [AD フォレストの回復-問題の特定](AD-Forest-Recovery-Identify-the-Problem.md)
- [AD フォレストの回復-回復方法を決定する](AD-Forest-Recovery-Determine-how-to-Recover.md)
- [AD フォレストの回復-最初の回復を実行する](AD-Forest-Recovery-Perform-initial-recovery.md)
- [AD フォレストの回復 - 手順](AD-Forest-Recovery-Procedures.md)
- [AD フォレストの回復-よく寄せられる質問](AD-Forest-Recovery-FAQ.md)
- [AD フォレストの回復-マルチドメインフォレスト内の単一ドメインの回復](AD-Forest-Recovery-Single-Domain-in-Multidomain-Recovery.md)
- [AD フォレストの回復-Windows Server 2003 ドメインコントローラーを使用したフォレストの回復](AD-Forest-Recovery-Windows-Server-2003.md)
